{% extends "base.html" %}

{% block title %}Team bearbeiten - {{ team.name }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Admin Dashboard Theme - Dark Professional */
    .admin-dashboard-container {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        min-height: 100vh;
        color: white;
        position: relative;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .admin-dashboard-container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(52, 73, 94, 0.1) 25%, transparent 25%),
                    linear-gradient(-45deg, rgba(52, 73, 94, 0.1) 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, rgba(52, 73, 94, 0.1) 75%),
                    linear-gradient(-45deg, transparent 75%, rgba(52, 73, 94, 0.1) 75%);
        background-size: 60px 60px;
        background-position: 0 0, 0 30px, 30px -30px, -30px 0px;
        animation: movePattern 20s linear infinite;
        opacity: 0.15;
        z-index: -1;
        pointer-events: none;
    }

    @keyframes movePattern {
        0% { transform: translateX(0px) translateY(0px); }
        100% { transform: translateX(60px) translateY(60px); }
    }

    .admin-content {
        position: relative;
        z-index: 2;
        padding: 2rem 0;
        min-height: 100vh;
    }

    .admin-content .container {
        max-width: 1200px;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }

    /* Header styling */
    .admin-content h1, .admin-content h2 {
        color: white;
        font-weight: 700;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Card styling */
    .card {
        background: rgba(44, 62, 80, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        backdrop-filter: blur(15px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .card-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px 18px 0 0 !important;
        padding: 1.5rem 2rem;
    }

    .card-header.bg-primary {
        background: rgba(52, 152, 219, 0.2) !important;
        border-bottom: 1px solid rgba(52, 152, 219, 0.3);
    }

    .card-header.bg-warning {
        background: rgba(241, 196, 15, 0.2) !important;
        border-bottom: 1px solid rgba(241, 196, 15, 0.3);
    }

    .card-header.bg-success {
        background: rgba(39, 174, 96, 0.2) !important;
        border-bottom: 1px solid rgba(39, 174, 96, 0.3);
    }

    .card-header.bg-danger {
        background: rgba(231, 76, 60, 0.2) !important;
        border-bottom: 1px solid rgba(231, 76, 60, 0.3);
    }

    .card-header.bg-info {
        background: rgba(26, 188, 156, 0.2) !important;
        border-bottom: 1px solid rgba(26, 188, 156, 0.3);
    }

    .card-header h5 {
        margin: 0;
        font-weight: 700;
        color: white !important;
    }

    .card-body {
        padding: 2rem;
    }

    .card-footer {
        background: rgba(44, 62, 80, 0.2) !important;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1.5rem 2rem;
    }

    /* Alert styling */
    .alert {
        border-radius: 15px;
        border: none;
        padding: 1rem 1.5rem;
        backdrop-filter: blur(10px);
        font-weight: 500;
        margin-bottom: 1.5rem;
    }

    .alert-success {
        background: rgba(39, 174, 96, 0.2);
        border: 1px solid rgba(39, 174, 96, 0.3);
        color: white;
    }

    .alert-danger {
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid rgba(231, 76, 60, 0.3);
        color: white;
    }

    .alert-warning {
        background: rgba(241, 196, 15, 0.2);
        border: 1px solid rgba(241, 196, 15, 0.3);
        color: white;
    }

    .alert-info {
        background: rgba(26, 188, 156, 0.2);
        border: 1px solid rgba(26, 188, 156, 0.3);
        color: white;
    }

    /* Form styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control-label {
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: white;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(52, 152, 219, 0.5);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        color: white;
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .form-text {
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .invalid-feedback {
        color: #e74c3c;
        font-weight: 500;
    }

    .form-control.is-invalid {
        border-color: #e74c3c;
        background: rgba(231, 76, 60, 0.1);
    }

    /* Select styling */
    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 12px center;
        background-repeat: no-repeat;
        background-size: 16px 12px;
        padding-right: 40px;
    }

    /* Button styling */
    .btn {
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        padding: 12px 24px;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    .btn-primary {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(45deg, #2980b9, #21618c);
        color: white;
        box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
    }

    .btn-success {
        background: linear-gradient(45deg, #27ae60, #229954);
        color: white;
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-success:hover {
        background: linear-gradient(45deg, #229954, #1e8449);
        color: white;
        box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
    }

    .btn-danger {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
    }

    .btn-danger:hover {
        background: linear-gradient(45deg, #c0392b, #a93226);
        color: white;
        box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
    }

    .btn-warning {
        background: linear-gradient(45deg, #f1c40f, #f39c12);
        color: #2c3e50;
        box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3);
    }

    .btn-warning:hover {
        background: linear-gradient(45deg, #f39c12, #e67e22);
        color: #2c3e50;
        box-shadow: 0 8px 20px rgba(241, 196, 15, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        color: white;
        box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
    }

    .btn-secondary:hover {
        background: linear-gradient(45deg, #7f8c8d, #6c7b7d);
        color: white;
        box-shadow: 0 8px 20px rgba(149, 165, 166, 0.4);
    }

    .btn-lg {
        padding: 16px 32px;
        font-size: 1.1rem;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    /* Table styling */
    .table {
        color: white;
        margin-bottom: 0;
    }

    .table thead th {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
    }

    .table tbody td {
        border-color: rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .table-responsive {
        border-radius: 15px;
        overflow: hidden;
    }

    /* Badge styling */
    .badge {
        border-radius: 15px;
        padding: 0.4rem 0.8rem;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-success {
        background: linear-gradient(45deg, #27ae60, #229954);
        color: white;
    }

    .badge-warning {
        background: linear-gradient(45deg, #f1c40f, #f39c12);
        color: #2c3e50;
    }

    .badge-danger {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
    }

    .badge-primary {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
    }

    .badge-secondary {
        background: rgba(149, 165, 166, 0.8);
        color: white;
    }

    /* Progress styling */
    .progress {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 20px;
    }

    .progress-bar {
        border-radius: 10px;
        background: linear-gradient(45deg, #27ae60, #229954);
    }

    /* Text colors */
    .text-muted {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    /* Breadcrumb styling */
    .breadcrumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
    }

    .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
    }

    .breadcrumb-item a:hover {
        color: white;
    }

    .breadcrumb-item.active {
        color: white;
    }

    /* Character preview */
    .character-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .character-preview:hover {
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.6);
    }

    @media (max-width: 768px) {
        .admin-content .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .card-body, .card-header, .card-footer {
            padding: 1.5rem;
        }

        .btn-lg {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .admin-content h1, .admin-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-container">
    <div class="admin-content">
        <div class="container">
    <div class="row">
        <div class="col-md-8">
            <h2><i class="fas fa-users"></i> Team "{{ team.name }}" bearbeiten</h2>
            <form method="POST" action="" novalidate>
                {{ form.hidden_tag() }}
                
                <!-- Team-Grunddaten -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Team-Grunddaten</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            {{ form.team_name.label(class="form-control-label") }}
                            {{ form.team_name(class="form-control" + (" is-invalid" if form.team_name.errors else ""), placeholder="Teamname") }}
                            {% if form.team_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.team_name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.character_id.label(class="form-control-label") }}
                            {{ form.character_id(class="form-control" + (" is-invalid" if form.character_id.errors else "")) }}
                            {% if form.character_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.character_id.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Passwort √§ndern -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-key"></i> Passwort √§ndern</h5>
                    </div>
                    <div class="card-body">
                        {% if team.welcome_password %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Aktuelles Passwort:</strong> 
                            <code>{{ team.welcome_password }}</code>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            {{ form.password.label(class="form-control-label") }}
                            {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), placeholder="Neues Passwort (leer lassen, um nicht zu √§ndern)") }}
                            {% if form.password.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.password.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.confirm_password.label(class="form-control-label") }}
                            {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), placeholder="Passwort best√§tigen") }}
                            {% if form.confirm_password.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.confirm_password.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Spielstatus -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-dice"></i> Spielstatus bearbeiten</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.current_position.label(class="form-control-label") }}
                                    {{ form.current_position(class="form-control" + (" is-invalid" if form.current_position.errors else ""), placeholder="0-72", value=team.current_position) }}
                                    {% if form.current_position.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.current_position.errors %}<span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Position auf dem Spielbrett (0 = Start, 72 = Ziel)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form.last_dice_result.label(class="form-control-label") }}
                                    {{ form.last_dice_result(class="form-control" + (" is-invalid" if form.last_dice_result.errors else ""), placeholder="1-6", value=team.last_dice_result) }}
                                    {% if form.last_dice_result.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.last_dice_result.errors %}<span>{{ error }}</span>{% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Letztes gew√ºrfeltes Ergebnis (1-6, leer lassen f√ºr nicht gesetzt)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teammitglieder bearbeiten -->
                
                <div class="form-group">
                    {{ form.submit(class="btn btn-primary") }}
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary ml-2">Abbrechen</a>
                </div>
            </form>
            
            <!-- Team-Spieler Management - au√üerhalb des Forms -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-friends"></i> Team-Spieler</h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="openAddPlayerModal()">
                        <i class="fas fa-user-plus"></i> Spieler hinzuf√ºgen
                    </button>
                </div>
                <div class="card-body">
                    {% set all_team_players = [] %}
                    
                    {# Sammle alle Spieler aus player_registrations #}
                    {% for player in team.player_registrations %}
                        {% set _ = all_team_players.append({
                            'id': player.id,
                            'name': player.player_name,
                            'registration_time': player.registration_time,
                            'type': 'registration',
                            'profile_image_path': player.profile_image_path,
                            'has_profile_image': player.profile_image_path is not none
                        }) %}
                    {% endfor %}
                    
                    {# Sammle zus√§tzliche Spieler aus team.members (die nicht in registrations sind) #}
                    {% if team.members %}
                        {% set registered_names = team.player_registrations|map(attribute='player_name')|list %}
                        {% set team_profile_images = team.get_profile_images() or {} %}
                        {% for member_name in team.members.split(',') %}
                            {% set clean_name = member_name.strip() %}
                            {% if clean_name and clean_name not in registered_names %}
                                {% set _ = all_team_players.append({
                                    'id': 'member_' + loop.index0|string,
                                    'name': clean_name,
                                    'registration_time': none,
                                    'type': 'member',
                                    'profile_image': team_profile_images.get(clean_name),
                                    'has_profile_image': team_profile_images.get(clean_name) is not none
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    {% if all_team_players %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Profilbild</th>
                                        <th>Spielername</th>
                                        <th>Registriert am</th>
                                        <th>Typ</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in all_team_players %}
                                    <tr id="player-row-{{ player.id }}">
                                        <td class="text-center">
                                            <div class="profile-image-container" style="position: relative; display: inline-block;">
                                                {% set has_image = (player.type == 'registration' and player.profile_image_path) or (player.type == 'member' and player.profile_image) %}
                                                
                                                {% if has_image %}
                                                    {# Zeige nur Profilbild #}
                                                    <img src="/static/{% if player.type == 'registration' %}{{ player.profile_image_path }}{% else %}{{ player.profile_image }}{% endif %}" 
                                                         class="player-profile-img" 
                                                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid {% if player.type == 'registration' %}#007bff{% else %}#6c757d{% endif %};"
                                                         alt="{{ player.name }}"
                                                         onerror="this.src=''; this.style.display='none'; showEmojiForPlayer('{{ player.name }}', '{{ player.id }}', '{% if player.type == 'registration' %}#007bff{% else %}#6c757d{% endif %}');">
                                                {% else %}
                                                    {# Zeige nur Emoji (kein Bild vorhanden) #}
                                                    <div class="emoji-display" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid {% if player.type == 'registration' %}#007bff{% else %}#6c757d{% endif %}; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                                        <span id="player-emoji-{{ player.id }}" class="player-emoji" data-name="{{ player.name }}">üë§</span>
                                                    </div>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-secondary" 
                                                        style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; padding: 0; font-size: 10px;"
                                                        onclick="openImageEditModal('{{ player.name }}', '{{ player.id }}', '{{ player.type }}')"
                                                        title="Profilbild bearbeiten">
                                                    <i class="fas fa-camera"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <span id="player-name-{{ player.id }}">{{ player.name }}</span>
                                            <input type="text" class="form-control form-control-sm d-none" 
                                                   id="player-name-input-{{ player.id }}" 
                                                   value="{{ player.name }}" 
                                                   maxlength="100">
                                        </td>
                                        <td>
                                            {% if player.registration_time %}
                                                {{ player.registration_time.strftime('%d.%m.%Y %H:%M') }}
                                            {% else %}
                                                <small class="text-muted">Nachtr√§glich hinzugef√ºgt</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if player.type == 'registration' %}
                                                <span class="badge badge-primary">Registriert</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Team-Mitglied</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        type="button"
                                                        onclick="{% if player.type == 'registration' %}editPlayerName({{ player.id }}){% else %}editMemberName('{{ player.name }}', '{{ player.id }}'){% endif %}" 
                                                        id="edit-btn-{{ player.id }}">
                                                    <i class="fas fa-edit"></i> Bearbeiten
                                                </button>
                                                <button class="btn btn-outline-success btn-sm d-none" 
                                                        type="button"
                                                        onclick="{% if player.type == 'registration' %}savePlayerName({{ player.id }}){% else %}saveMemberName('{{ player.name }}', '{{ player.id }}'){% endif %}" 
                                                        id="save-btn-{{ player.id }}">
                                                    <i class="fas fa-save"></i> Speichern
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm d-none" 
                                                        type="button"
                                                        onclick="{% if player.type == 'registration' %}cancelPlayerEdit({{ player.id }}){% else %}cancelMemberEdit('{{ player.id }}'){% endif %}" 
                                                        id="cancel-btn-{{ player.id }}">
                                                    <i class="fas fa-times"></i> Abbrechen
                                                </button>
                                                <select class="form-control form-control-sm" 
                                                        style="width: auto; display: inline-block;"
                                                        onchange="{% if player.type == 'registration' %}handleTeamChange(this, {{ player.id }}){% else %}handleMemberTeamChange(this, '{{ player.name }}'){% endif %}"
                                                        id="team-select-{{ player.id }}">
                                                    <option value="">-- Team √§ndern --</option>
                                                    {% for other_team in all_teams %}
                                                        {% if other_team.id != team.id %}
                                                        <option value="{{ other_team.id }}">{{ other_team.name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <option value="0">Kein Team zuweisen</option>
                                                </select>
                                                <button class="btn btn-outline-danger btn-sm ml-2" 
                                                        type="button"
                                                        onclick="{% if player.type == 'registration' %}deletePlayer({{ player.id }}){% else %}removeFromTeamMembers('{{ player.name }}'){% endif %}" 
                                                        title="Spieler l√∂schen">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Diesem Team sind noch keine Spieler zugeordnet.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Erweiterte Spieler-Auslosungs-Verwaltung -->
            {% if all_team_players %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-dice"></i> Auslosungs-Einstellungen</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Hinweis:</strong> Hier k√∂nnen Sie festlegen, welche Spieler f√ºr Minispiele ausgelost werden k√∂nnen. 
                        Bei "Ganzes Team" spielen alle mit, unabh√§ngig von diesen Einstellungen.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Spielername</th>
                                    <th>Typ</th>
                                    <th>Kann ausgelost werden</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="player-selection-table">
                                {% set player_config = team.get_player_config() %}
                                {% for player in all_team_players %}
                                    {% set can_be_selected = player_config.get(player.name, {}).get('can_be_selected', True) %}
                                    <tr id="player-selection-row-{{ player.id }}">
                                        <td>
                                            <i class="fas fa-user text-{{ 'primary' if player.type == 'registration' else 'secondary' }}"></i>
                                            <strong>{{ player.name }}</strong>
                                        </td>
                                        <td>
                                            {% if player.type == 'registration' %}
                                                <span class="badge badge-primary">Registriert</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Team-Mitglied</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ 'success' if can_be_selected else 'secondary' }}" 
                                                  id="status-badge-{{ player.id }}">
                                                {{ 'Ja' if can_be_selected else 'Nein' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-{{ 'secondary' if can_be_selected else 'success' }}"
                                                    onclick="togglePlayerSelection('{{ player.name }}', {{ team.id }}, '{{ player.id }}', {{ 'false' if can_be_selected else 'true' }})"
                                                    id="toggle-btn-{{ player.id }}">
                                                <i class="fas fa-{{ 'ban' if can_be_selected else 'check' }}"></i>
                                                {{ 'Deaktivieren' if can_be_selected else 'Aktivieren' }}
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Team-Info Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info"></i> Team-Informationen</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Team ID:</strong></td>
                            <td>{{ team.id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Aktuelle Position:</strong></td>
                            <td>{{ team.current_position }}</td>
                        </tr>
                        <tr>
                            <td><strong>Letzter W√ºrfel:</strong></td>
                            <td>{{ team.last_dice_result if team.last_dice_result else 'Nicht gesetzt' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Bonus-W√ºrfel:</strong></td>
                            <td>{{ team.bonus_dice_sides if team.bonus_dice_sides else 'Keine' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Blockiert:</strong></td>
                            <td>
                                {% if team.is_blocked %}
                                    <span class="badge badge-danger">Ja</span>
                                    {% if team.blocked_target_number %}
                                        <br><small>Ben√∂tigt: {{ team.blocked_target_number }}+</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-success">Nein</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if team.character %}
                        <tr>
                            <td><strong>Charakter:</strong></td>
                            <td>{{ team.character.name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript f√ºr Spieler-Management
function editPlayerName(playerId) {
    console.log('editPlayerName called with ID:', playerId);
    try {
        // Zeige Input-Feld und verstecke Anzeige
        document.getElementById('player-name-' + playerId).classList.add('d-none');
        document.getElementById('player-name-input-' + playerId).classList.remove('d-none');
        
        // Zeige Save/Cancel Buttons und verstecke Edit Button
        document.getElementById('edit-btn-' + playerId).classList.add('d-none');
        document.getElementById('save-btn-' + playerId).classList.remove('d-none');
        document.getElementById('cancel-btn-' + playerId).classList.remove('d-none');
        
        // Focus auf Input-Feld
        document.getElementById('player-name-input-' + playerId).focus();
    } catch (error) {
        console.error('Error in editPlayerName:', error);
        alert('Fehler beim Aktivieren des Bearbeitungsmodus.');
    }
}

function cancelPlayerEdit(playerId) {
    // Verstecke Input-Feld und zeige Anzeige
    document.getElementById('player-name-' + playerId).classList.remove('d-none');
    document.getElementById('player-name-input-' + playerId).classList.add('d-none');
    
    // Verstecke Save/Cancel Buttons und zeige Edit Button
    document.getElementById('edit-btn-' + playerId).classList.remove('d-none');
    document.getElementById('save-btn-' + playerId).classList.add('d-none');
    document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
}

function savePlayerName(playerId) {
    const newName = document.getElementById('player-name-input-' + playerId).value.trim();
    
    if (newName.length < 2) {
        alert('Spielername muss mindestens 2 Zeichen lang sein.');
        return;
    }
    
    // AJAX Request zum Speichern
    fetch('/admin/update_player_name', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_id: playerId,
            new_name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update anzeigen
            document.getElementById('player-name-' + playerId).textContent = newName;
            
            // Verstecke Input-Feld und zeige Anzeige
            document.getElementById('player-name-' + playerId).classList.remove('d-none');
            document.getElementById('player-name-input-' + playerId).classList.add('d-none');
            
            // Verstecke Save/Cancel Buttons und zeige Edit Button
            document.getElementById('edit-btn-' + playerId).classList.remove('d-none');
            document.getElementById('save-btn-' + playerId).classList.add('d-none');
            document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
            
            // Success-Meldung
            showAlert('Spielername erfolgreich aktualisiert.', 'success');
        } else {
            alert('Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern des Spielernamens.');
    });
}

function handleTeamChange(selectElement, playerId) {
    const newTeamId = parseInt(selectElement.value);
    if (!newTeamId && newTeamId !== 0) {
        return; // Keine Auswahl getroffen
    }
    
    const newTeamName = selectElement.options[selectElement.selectedIndex].text;
    
    // Reset select nach Best√§tigung/Abbruch
    const resetSelect = () => {
        selectElement.selectedIndex = 0;
    };
    
    const confirmMsg = newTeamId === 0 
        ? 'M√∂chten Sie den Spieler wirklich keinem Team zuweisen?' 
        : `M√∂chten Sie den Spieler wirklich dem Team "${newTeamName}" zuweisen?`;
    
    if (!confirm(confirmMsg)) {
        resetSelect();
        return;
    }
    
    reassignPlayer(playerId, newTeamId, newTeamName, resetSelect);
}

function reassignPlayer(playerId, newTeamId, newTeamName, callback = null) {
    console.log('reassignPlayer called:', {playerId, newTeamId, newTeamName});
    
    // AJAX Request f√ºr Team-Zuordnung
    fetch('/admin/reassign_player', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_id: playerId,
            new_team_id: newTeamId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (newTeamId === 0) {
                // Spieler aus aktuellem Team entfernen
                document.getElementById('player-row-' + playerId).remove();
                showAlert('Spieler erfolgreich aus dem Team entfernt.', 'info');
            } else {
                // Spieler aus aktuellem Team entfernen
                document.getElementById('player-row-' + playerId).remove();
                showAlert(`Spieler erfolgreich dem Team "${newTeamName}" zugewiesen.`, 'success');
            }
            
            // Pr√ºfe ob noch Spieler im Team sind
            const remainingRows = document.querySelectorAll('tbody tr[id^="player-row-"]');
            if (remainingRows.length === 0) {
                location.reload(); // Reload um "Keine Spieler" Nachricht anzuzeigen
            }
        } else {
            alert('Fehler bei der Team-Zuweisung: ' + (data.error || 'Unbekannter Fehler'));
            if (callback) callback(); // Reset select bei Fehler
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler bei der Team-Zuweisung.');
        if (callback) callback(); // Reset select bei Fehler
    });
}

function showAlert(message, type) {
    // Erstelle tempor√§re Alert-Box
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    // F√ºge Alert oben auf der Seite hinzu
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Entferne Alert nach 5 Sekunden
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Enter-Taste f√ºr Speichern
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        const target = event.target;
        if (target.id && target.id.startsWith('player-name-input-')) {
            const playerId = target.id.replace('player-name-input-', '');
            savePlayerName(playerId);
        }
    }
});

// Neue Funktion f√ºr Spieler-Auslosungs-Verwaltung
function togglePlayerSelection(playerName, teamId, rowIndex, newStatus) {
    console.log('togglePlayerSelection called:', {playerName, teamId, rowIndex, newStatus});
    
    const canBeSelected = newStatus === 'true';
    
    // AJAX Request f√ºr Auslosungs-Status
    fetch(`/admin/api/update_player_selection_status/${teamId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            player_name: playerName,
            can_be_selected: canBeSelected
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // UI aktualisieren
            const statusBadge = document.getElementById(`status-badge-${rowIndex}`);
            const toggleBtn = document.getElementById(`toggle-btn-${rowIndex}`);
            
            if (canBeSelected) {
                statusBadge.textContent = 'Ja';
                statusBadge.className = 'badge badge-success';
                toggleBtn.innerHTML = '<i class="fas fa-ban"></i> Deaktivieren';
                toggleBtn.className = 'btn btn-sm btn-secondary';
                toggleBtn.setAttribute('onclick', `togglePlayerSelection('${playerName}', ${teamId}, '${rowIndex}', 'false')`);
            } else {
                statusBadge.textContent = 'Nein';
                statusBadge.className = 'badge badge-secondary';
                toggleBtn.innerHTML = '<i class="fas fa-check"></i> Aktivieren';
                toggleBtn.className = 'btn btn-sm btn-success';
                toggleBtn.setAttribute('onclick', `togglePlayerSelection('${playerName}', ${teamId}, '${rowIndex}', 'true')`);
            }
            
            // Erfolgs-Toast oder Notification
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message || 'Fehler beim Aktualisieren', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ein Fehler ist aufgetreten', 'error');
    });
}

function showNotification(message, type) {
    // Einfache Benachrichtigung (kann erweitert werden)
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        <strong>${type === 'success' ? 'Erfolg!' : 'Fehler!'}</strong> ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove nach 3 Sekunden
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Neues Modal-System f√ºr Spieler hinzuf√ºgen
function openAddPlayerModal() {
    document.getElementById('add-player-modal').style.display = 'flex';
    document.getElementById('add-player-name').focus();
    
    // Reset modal state
    resetAddPlayerModal();
}

function closeAddPlayerModal() {
    document.getElementById('add-player-modal').style.display = 'none';
    resetAddPlayerModal();
}

function resetAddPlayerModal() {
    // Reset zu Step 1
    document.getElementById('add-player-step-1').style.display = 'block';
    document.getElementById('add-player-step-2').style.display = 'none';
    
    // Reset step indicators
    document.getElementById('add-player-step-dot-1').classList.add('active');
    document.getElementById('add-player-step-dot-2').classList.remove('active');
    
    // Reset form
    document.getElementById('add-player-name').value = '';
    document.getElementById('add-player-status').style.display = 'none';
    
    // Reset camera
    resetAddPlayerCamera();
}

function proceedToAddPlayerCamera() {
    const playerName = document.getElementById('add-player-name').value.trim();
    if (!playerName) {
        showAddPlayerStatus('Bitte gib einen Namen ein!', 'error');
        return;
    }
    
    if (playerName.length < 2) {
        showAddPlayerStatus('Name muss mindestens 2 Zeichen lang sein!', 'error');
        return;
    }
    
    // Switch to camera step
    document.getElementById('add-player-step-1').style.display = 'none';
    document.getElementById('add-player-step-2').style.display = 'block';
    
    // Update step indicator
    document.getElementById('add-player-step-dot-1').classList.remove('active');
    document.getElementById('add-player-step-dot-2').classList.add('active');
    
    // Clear status
    document.getElementById('add-player-status').style.display = 'none';
    
    resetAddPlayerCamera();
}

function backToAddPlayerNameStep() {
    // Stop camera if running
    stopAddPlayerCamera();
    
    // Switch back to name step
    document.getElementById('add-player-step-2').style.display = 'none';
    document.getElementById('add-player-step-1').style.display = 'block';
    
    // Update step indicator
    document.getElementById('add-player-step-dot-2').classList.remove('active');
    document.getElementById('add-player-step-dot-1').classList.add('active');
    
    // Clear status
    document.getElementById('add-player-status').style.display = 'none';
}

// Kamera-Funktionen f√ºr Spieler-Hinzuf√ºgen
let addPlayerCameraStream = null;
let addPlayerCapturedImageData = null;

function resetAddPlayerCamera() {
    stopAddPlayerCamera();
    
    document.getElementById('add-player-btn-start-camera').style.display = 'inline-block';
    document.getElementById('add-player-btn-take-photo').style.display = 'none';
    document.getElementById('add-player-btn-retake-photo').style.display = 'none';
    document.getElementById('add-player-btn-save-and-add').style.display = 'none';
    
    document.getElementById('add-player-camera-video').style.display = 'block';
    document.getElementById('add-player-camera-captured').style.display = 'none';
    
    document.getElementById('add-player-camera-status').textContent = 'Klicke auf "Kamera starten" um ein Foto aufzunehmen.';
    
    addPlayerCapturedImageData = null;
}

async function startAddPlayerCamera() {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Kamera wird gestartet...';
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Kamera-API nicht verf√ºgbar. HTTPS oder neuerer Browser erforderlich.');
        }
        
        try {
            addPlayerCameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 640, max: 1280 }
                } 
            });
        } catch (basicError) {
            addPlayerCameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' }
            });
        }
        
        const video = document.getElementById('add-player-camera-video');
        video.srcObject = addPlayerCameraStream;
        
        video.onloadedmetadata = function() {
            video.play();
            document.getElementById('add-player-btn-start-camera').style.display = 'none';
            document.getElementById('add-player-btn-take-photo').style.display = 'inline-block';
            document.getElementById('add-player-camera-status').textContent = 'Kamera aktiv - Position dich gut und klicke auf "Foto aufnehmen".';
        };
        
    } catch (error) {
        console.error('Kamera-Fehler:', error);
        document.getElementById('add-player-camera-status').innerHTML = `
            <div style="color: #ff6b6b;">‚ùå Kamera konnte nicht gestartet werden: ${error.message}</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Du kannst trotzdem "Ohne Foto fortfahren" w√§hlen.</div>
        `;
        
        const skipButton = document.getElementById('add-player-btn-skip-photo');
        if (skipButton) {
            skipButton.style.background = 'linear-gradient(45deg, #4CAF50, #45A049)';
            skipButton.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto hinzuf√ºgen (empfohlen)';
        }
    }
}

function stopAddPlayerCamera() {
    if (addPlayerCameraStream) {
        addPlayerCameraStream.getTracks().forEach(track => track.stop());
        addPlayerCameraStream = null;
    }
}

function takeAddPlayerPhoto() {
    const video = document.getElementById('add-player-camera-video');
    const canvas = document.getElementById('add-player-camera-canvas');
    const capturedImg = document.getElementById('add-player-camera-captured');
    
    canvas.width = 150;
    canvas.height = 150;
    
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(75, 75, 75, 0, 2 * Math.PI);
    ctx.clip();
    
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    
    addPlayerCapturedImageData = canvas.toDataURL('image/jpeg', 0.85);
    
    capturedImg.src = addPlayerCapturedImageData;
    capturedImg.style.display = 'block';
    video.style.display = 'none';
    
    document.getElementById('add-player-btn-take-photo').style.display = 'none';
    document.getElementById('add-player-btn-retake-photo').style.display = 'inline-block';
    document.getElementById('add-player-btn-save-and-add').style.display = 'inline-block';
    
    document.getElementById('add-player-camera-status').textContent = 'Foto aufgenommen! Gef√§llt es dir?';
    
    stopAddPlayerCamera();
}

function retakeAddPlayerPhoto() {
    document.getElementById('add-player-camera-video').style.display = 'block';
    document.getElementById('add-player-camera-captured').style.display = 'none';
    
    document.getElementById('add-player-btn-retake-photo').style.display = 'none';
    document.getElementById('add-player-btn-save-and-add').style.display = 'none';
    document.getElementById('add-player-btn-start-camera').style.display = 'inline-block';
    
    addPlayerCapturedImageData = null;
    document.getElementById('add-player-camera-status').textContent = 'Klicke auf "Kamera starten" um es nochmal zu versuchen.';
}

async function savePhotoAndAddPlayer() {
    const playerName = document.getElementById('add-player-name').value.trim();
    
    if (!playerName) {
        showAddPlayerStatus('Spielername fehlt!', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('add-player-btn-save-and-add');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird hinzugef√ºgt...';
    }
    
    try {
        // Erst Spieler hinzuf√ºgen
        const playerAdded = await addPlayerToTeam(playerName);
        
        // Dann Foto hochladen falls erfolgreich und Foto vorhanden
        if (playerAdded && addPlayerCapturedImageData) {
            await uploadPlayerImage(playerName);
        }
    } finally {
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Speichern & Hinzuf√ºgen';
        }
    }
}

async function skipPhotoAndAddPlayer() {
    const playerName = document.getElementById('add-player-name').value.trim();
    
    if (!playerName) {
        showAddPlayerStatus('Spielername fehlt!', 'error');
        return;
    }
    
    const skipBtn = document.getElementById('add-player-btn-skip-photo');
    if (skipBtn) {
        skipBtn.disabled = true;
        skipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird hinzugef√ºgt...';
    }
    
    try {
        await addPlayerToTeam(playerName);
    } finally {
        if (skipBtn) {
            skipBtn.disabled = false;
            skipBtn.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto hinzuf√ºgen';
        }
    }
}

async function addPlayerToTeam(playerName) {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Spieler wird hinzugef√ºgt...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        const response = await fetch('/admin/add_player_to_team', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                team_id: {{ team.id }},
                player_name: playerName 
            })
        });
        
        // Response als Text holen und dann als JSON parsen
        const responseText = await response.text();
        console.log('Response text:', responseText);
        
        if (!response.ok) {
            let errorMessage;
            try {
                const errorData = JSON.parse(responseText);
                errorMessage = errorData.error || `HTTP error! status: ${response.status}`;
            } catch (parseError) {
                console.error('Response text:', responseText);
                errorMessage = `HTTP error! status: ${response.status} - ${responseText.substring(0, 100)}`;
            }
            throw new Error(errorMessage);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Expected JSON, got:', responseText);
            throw new Error('Server returned non-JSON response: ' + responseText.substring(0, 100));
        }
        
        const data = JSON.parse(responseText);
        
        if (data.success) {
            document.getElementById('add-player-camera-status').textContent = '‚úÖ Spieler erfolgreich hinzugef√ºgt!';
            showAddPlayerStatus('Erfolgreich hinzugef√ºgt! üéâ', 'success');
            
            // Aktualisiere das Team-Members Textfeld
            updateTeamMembersField();
            
            setTimeout(() => {
                closeAddPlayerModal();
                // Reload page to show new player in the list
                window.location.reload();
            }, 2000);
            return true;
        } else {
            showAddPlayerStatus(data.error || 'Fehler beim Hinzuf√ºgen', 'error');
            document.getElementById('add-player-camera-status').innerHTML = `<div style="color: #ff6b6b;">‚ùå ${data.error || 'Fehler beim Hinzuf√ºgen'}</div>`;
            return false;
        }
        
    } catch (error) {
        console.error('Add player error:', error);
        const errorMessage = error.message || 'Ein Fehler ist aufgetreten. Versuche es nochmal!';
        showAddPlayerStatus(errorMessage, 'error');
        document.getElementById('add-player-camera-status').innerHTML = `<div style="color: #ff6b6b;">‚ùå ${errorMessage}</div>`;
        return false;
    }
}

async function uploadPlayerImage(playerName) {
    try {
        document.getElementById('add-player-camera-status').textContent = 'Profilbild wird gespeichert...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        const response = await fetch('/admin/upload_team_player_image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                team_id: {{ team.id }},
                player_name: playerName,
                image_data: addPlayerCapturedImageData
            })
        });
        
        if (!response.ok) {
            let errorMessage;
            try {
                // Erst response text holen, dann versuchen als JSON zu parsen
                const responseText = await response.text();
                console.error('Upload response text:', responseText);
                
                try {
                    const errorData = JSON.parse(responseText);
                    errorMessage = errorData.error || `HTTP error! status: ${response.status}`;
                } catch (jsonError) {
                    errorMessage = `HTTP error! status: ${response.status} - ${responseText.substring(0, 100)}`;
                }
            } catch (textError) {
                errorMessage = `HTTP error! status: ${response.status}`;
            }
            throw new Error(errorMessage);
        }
        
        // Response als Text holen und dann als JSON parsen
        const responseText = await response.text();
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Expected JSON, got:', responseText);
            throw new Error('Server returned non-JSON response: ' + responseText.substring(0, 100));
        }
        
        const result = JSON.parse(responseText);
        
        if (result.success) {
            document.getElementById('add-player-camera-status').textContent = '‚úÖ Profilbild gespeichert!';
            showAddPlayerStatus('Erfolgreich hinzugef√ºgt mit Profilbild! üéâüì∏', 'success');
        } else {
            showAddPlayerStatus('Hinzugef√ºgt, aber Profilbild-Fehler: ' + result.error, 'error');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        showAddPlayerStatus('Hinzugef√ºgt, aber Profilbild konnte nicht gespeichert werden.', 'error');
    }
}

function updateTeamMembersField() {
    // Diese Funktion aktualisiert das Members-Textfeld
    // Da wir die Seite neu laden, ist das hier nicht n√∂tig
    // Aber f√ºr den Fall, dass wir es sp√§ter brauchen
}

function showAddPlayerStatus(message, type) {
    const statusDiv = document.getElementById('add-player-status');
    const messageSpan = document.getElementById('add-player-status-message');
    
    statusDiv.className = `add-player-status status-${type}`;
    messageSpan.textContent = message;
    statusDiv.style.display = 'block';
}

// ESC-Taste zum Schlie√üen des Modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('add-player-modal').style.display === 'flex') {
        closeAddPlayerModal();
    }
});

// Cleanup bei Seitenverlassen
window.addEventListener('beforeunload', function() {
    stopAddPlayerCamera();
});

// Spieler l√∂schen Funktion
function deletePlayer(playerId) {
    if (!confirm('M√∂chten Sie diesen Spieler wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/admin/delete_player', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            player_id: playerId
        })
    })
    .then(response => {
        return response.text().then(text => ({
            ok: response.ok,
            status: response.status,
            text: text
        }));
    })
    .then(({ok, status, text}) => {
        console.log('Delete response:', text);
        
        if (!ok) {
            try {
                const errorData = JSON.parse(text);
                throw new Error(errorData.error || `HTTP error! status: ${status}`);
            } catch (parseError) {
                throw new Error(`HTTP error! status: ${status} - ${text.substring(0, 100)}`);
            }
        }
        
        const data = JSON.parse(text);
        
        if (data.success) {
            // Entferne Spieler-Zeile aus der Tabelle
            document.getElementById('player-row-' + playerId).remove();
            alert('Spieler erfolgreich gel√∂scht!');
        } else {
            alert('Fehler beim L√∂schen: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Fehler beim L√∂schen des Spielers: ' + error.message);
    });
}

// Funktion zum Entfernen von Spielern aus team.members (nachtr√§glich hinzugef√ºgten Spielern)
function removeFromTeamMembers(playerName) {
    if (!confirm(`M√∂chten Sie "${playerName}" aus dem Team entfernen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/admin/remove_team_member', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            team_id: {{ team.id }},
            player_name: playerName
        })
    })
    .then(response => {
        return response.text().then(text => ({
            ok: response.ok,
            status: response.status,
            text: text
        }));
    })
    .then(({ok, status, text}) => {
        console.log('Remove member response:', text);
        
        if (!ok) {
            try {
                const errorData = JSON.parse(text);
                throw new Error(errorData.error || `HTTP error! status: ${status}`);
            } catch (parseError) {
                throw new Error(`Server error ${status}: ${text}`);
            }
        }
        
        const data = JSON.parse(text);
        if (data.success) {
            showAlert('Spieler erfolgreich aus Team entfernt.', 'success');
            // Reload page to update the display
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'Unbekannter Fehler');
        }
    })
    .catch(error => {
        console.error('Remove member error:', error);
        alert('Fehler beim Entfernen des Spielers: ' + error.message);
    });
}

// Emoji-Zuordnung f√ºr Spieler ohne Profilbild
function getPlayerEmoji(playerName) {
    const emojis = [
        "üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üôÉ", 
        "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô",
        "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î",
        "ü§ì", "üòé", "ü§°", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï",
        "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©", "ü•∫", "üò¢", "üò≠", "üò§",
        "üò†", "üò°", "ü§¨", "ü§Ø", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞"
    ];
    
    // Einfacher Hash f√ºr deterministische Emoji-Zuweisung
    let hash = 0;
    for (let i = 0; i < playerName.length; i++) {
        const char = playerName.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return emojis[Math.abs(hash) % emojis.length];
}

// Initialisiere Emojis beim Laden der Seite - nur f√ºr sichtbare Emoji-Displays
document.addEventListener('DOMContentLoaded', function() {
    // Nur Emojis in sichtbaren .emoji-display Bereichen initialisieren
    // NICHT in versteckten .emoji-fallback Bereichen
    document.querySelectorAll('.emoji-display .player-emoji').forEach(function(element) {
        const playerName = element.getAttribute('data-name');
        if (playerName) {
            // Pr√ºfe erst ob ein gespeichertes Emoji existiert
            const savedEmoji = getSavedPlayerEmoji(playerName);
            element.textContent = savedEmoji || getPlayerEmoji(playerName);
        }
    });
});

// Hole gespeichertes Emoji aus Team-Konfiguration
function getSavedPlayerEmoji(playerName) {
    // Diese Funktion w√ºrde das gespeicherte Emoji aus der Datenbank holen
    // F√ºr jetzt verwenden wir die deterministische Funktion
    {% if team and team.get_player_config() %}
    const playerConfig = {{ team.get_player_config()|tojson }};
    if (playerConfig && playerConfig[playerName] && playerConfig[playerName].emoji) {
        return playerConfig[playerName].emoji;
    }
    {% endif %}
    return null;
}

// Fallback-Funktion: Zeige Emoji wenn Profilbild nicht geladen werden kann
function showEmojiForPlayer(playerName, playerId, borderColor) {
    // Erstelle Emoji-Container dynamisch
    const container = document.querySelector(`#player-row-${playerId} .profile-image-container`);
    if (container) {
        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'emoji-fallback-dynamic';
        emojiDiv.style.cssText = `
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
            border: 2px solid ${borderColor} !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 20px !important;
        `;
        
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = getPlayerEmoji(playerName);
        emojiDiv.appendChild(emojiSpan);
        
        container.appendChild(emojiDiv);
    }
}

// Team-Wechsel f√ºr nachtr√§glich hinzugef√ºgte Mitglieder
function handleMemberTeamChange(selectElement, playerName) {
    const newTeamId = parseInt(selectElement.value);
    if (!newTeamId && newTeamId !== 0) {
        return; // Keine Auswahl getroffen
    }
    
    const newTeamName = selectElement.options[selectElement.selectedIndex].text;
    
    // Reset select nach Best√§tigung/Abbruch
    const resetSelect = () => {
        selectElement.selectedIndex = 0;
    };
    
    const confirmMsg = newTeamId === 0 
        ? `M√∂chten Sie "${playerName}" wirklich keinem Team zuweisen?` 
        : `M√∂chten Sie "${playerName}" wirklich dem Team "${newTeamName}" zuweisen?`;
    
    if (!confirm(confirmMsg)) {
        resetSelect();
        return;
    }
    
    moveMemberToTeam(playerName, newTeamId, newTeamName, resetSelect);
}

// Verschiebe Team-Mitglied zu anderem Team
function moveMemberToTeam(playerName, newTeamId, newTeamName, callback = null) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/admin/move_team_member', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            current_team_id: {{ team.id }},
            player_name: playerName,
            new_team_id: newTeamId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (newTeamId === 0) {
                showAlert(`"${playerName}" erfolgreich aus allen Teams entfernt.`, 'info');
            } else {
                showAlert(`"${playerName}" erfolgreich dem Team "${newTeamName}" zugewiesen.`, 'success');
            }
            
            // Reload page to update display
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Fehler beim Team-Wechsel: ' + (data.error || 'Unbekannter Fehler'));
            if (callback) callback(); // Reset select bei Fehler
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Team-Wechsel.');
        if (callback) callback(); // Reset select bei Fehler
    });
}

// Profilbild-Bearbeitung Modal √∂ffnen
function openImageEditModal(playerName, playerId, playerType) {
    console.log('Opening image edit modal for:', {playerName, playerId, playerType});
    
    // Erstelle und zeige das Image-Edit-Modal
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay-image-edit';
    modalOverlay.id = 'image-edit-modal';
    
    // Aktuelles Emoji aus verschiedenen Quellen bestimmen
    let currentEmoji;
    
    // 1. Versuche aus DOM zu lesen
    const currentEmojiElement = document.querySelector(`#player-emoji-${playerId}`);
    if (currentEmojiElement) {
        currentEmoji = currentEmojiElement.textContent;
        console.log('Current emoji from DOM:', currentEmoji);
    } else {
        // 2. Versuche gespeichertes Emoji zu laden
        const savedEmoji = getSavedPlayerEmoji(playerName);
        if (savedEmoji) {
            currentEmoji = savedEmoji;
        } else {
            // 3. Fallback auf deterministische Generierung
            currentEmoji = getPlayerEmoji(playerName);
        }
    }
    
    console.log('Final current emoji for', playerName, ':', currentEmoji);
    
    modalOverlay.innerHTML = `
        <div class="modal-container-image-edit">
            <button class="modal-close-image-edit" onclick="closeImageEditModal()">&times;</button>
            
            <div class="modal-header-image-edit">
                <h3 class="modal-title-image-edit">‚úèÔ∏è ${playerName} bearbeiten</h3>
                <p class="modal-subtitle-image-edit">Emoji oder Profilbild √§ndern</p>
            </div>

            <div class="modal-content-image-edit">
                <!-- Current Display -->
                <div class="current-display">
                    <h4>Aktuell:</h4>
                    <div class="current-image-container">
                        <div class="current-emoji" id="current-emoji-display">${currentEmoji}</div>
                    </div>
                </div>

                <!-- Emoji Section -->
                <div class="edit-section">
                    <h4><i class="fas fa-smile"></i> Emoji √§ndern</h4>
                    <div class="emoji-picker">
                        <div class="emoji-grid" id="emoji-grid">
                            <!-- Emojis werden dynamisch hinzugef√ºgt -->
                        </div>
                    </div>
                    <div class="selected-emoji-display">
                        <span>Ausgew√§hltes Emoji: </span>
                        <span class="selected-emoji" id="selected-emoji">${currentEmoji}</span>
                        <button class="btn-apply-emoji" onclick="applyEmojiChange('${playerName}', '${playerId}', '${playerType}')">
                            <i class="fas fa-check"></i> Emoji anwenden
                        </button>
                    </div>
                </div>

                <!-- Image Section -->
                <div class="edit-section">
                    <h4><i class="fas fa-camera"></i> Profilbild √§ndern</h4>
                    <div class="image-options">
                        <button class="btn-image-option" onclick="openImageUpload('${playerName}', '${playerId}', '${playerType}')">
                            <i class="fas fa-upload"></i> Neues Bild hochladen
                        </button>
                        <button class="btn-image-option btn-remove" onclick="removePlayerImage('${playerName}', '${playerId}', '${playerType}')">
                            <i class="fas fa-trash"></i> Bild entfernen
                        </button>
                    </div>
                    
                    <!-- Image Upload Area (hidden by default) -->
                    <div class="image-upload-area" id="image-upload-area" style="display: none;">
                        <div class="camera-preview-edit">
                            <video id="edit-camera-video" class="camera-video-edit" autoplay muted style="display: none;"></video>
                            <canvas id="edit-camera-canvas" class="camera-canvas-edit"></canvas>
                            <img id="edit-camera-captured" class="camera-captured-edit" style="display: none;">
                        </div>
                        
                        <div class="camera-controls-edit">
                            <button id="edit-btn-start-camera" class="btn-camera-edit btn-camera-capture-edit" onclick="startEditCamera()">
                                <i class="fas fa-video"></i> Kamera starten
                            </button>
                            <button id="edit-btn-take-photo" class="btn-camera-edit btn-camera-capture-edit" style="display: none;" onclick="takeEditPhoto()">
                                <i class="fas fa-camera"></i> Foto aufnehmen
                            </button>
                            <button id="edit-btn-retake-photo" class="btn-camera-edit btn-camera-retake-edit" style="display: none;" onclick="retakeEditPhoto()">
                                <i class="fas fa-redo"></i> Nochmal
                            </button>
                            <button id="edit-btn-save-image" class="btn-camera-edit btn-camera-save-edit" style="display: none;" onclick="savePlayerImage('${playerName}', '${playerId}', '${playerType}')">
                                <i class="fas fa-save"></i> Bild speichern
                            </button>
                        </div>
                        
                        <div class="camera-status-edit" id="edit-camera-status">
                            Klicke auf "Kamera starten" um ein neues Foto aufzunehmen.
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-buttons-image-edit">
                <button type="button" class="btn-modal-secondary-edit" onclick="closeImageEditModal()">
                    <i class="fas fa-times"></i> Schlie√üen
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modalOverlay);
    
    // Initialisiere Emoji-Grid
    initializeEmojiGrid();
    
    // Show modal
    modalOverlay.style.display = 'flex';
}

function closeImageEditModal() {
    const modal = document.getElementById('image-edit-modal');
    if (modal) {
        stopEditCamera();
        modal.remove();
    }
}

function initializeEmojiGrid() {
    const emojis = [
        "üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "ü§£", "üòÇ", "üôÇ", "üôÉ", 
        "üòâ", "üòä", "üòá", "ü•∞", "üòç", "ü§©", "üòò", "üòó", "üòö", "üòô",
        "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î",
        "ü§ì", "üòé", "ü§°", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï",
        "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©", "ü•∫", "üò¢", "üò≠", "üò§",
        "üò†", "üò°", "ü§¨", "ü§Ø", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞",
        "üë§", "üë•", "ü´Ç", "üë∂", "üßí", "üë¶", "üëß", "üßë", "üë®", "üë©",
        "üßì", "üë¥", "üëµ", "üë®‚Äç‚öïÔ∏è", "üë©‚Äç‚öïÔ∏è", "üë®‚Äçüéì", "üë©‚Äçüéì", "üë®‚Äçüíª", "üë©‚Äçüíª", "üßë‚Äçüíº",
        "‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±",
        "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "üéØ", "üéÆ", "üïπÔ∏è", "üé≤"
    ];
    
    const emojiGrid = document.getElementById('emoji-grid');
    emojis.forEach(emoji => {
        const emojiButton = document.createElement('button');
        emojiButton.className = 'emoji-button';
        emojiButton.textContent = emoji;
        emojiButton.onclick = () => selectEmoji(emoji);
        emojiGrid.appendChild(emojiButton);
    });
}

function selectEmoji(emoji) {
    // Update selected emoji display
    document.getElementById('selected-emoji').textContent = emoji;
    document.getElementById('current-emoji-display').textContent = emoji;
    
    // Highlight selected emoji
    document.querySelectorAll('.emoji-button').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.classList.add('selected');
}

function applyEmojiChange(playerName, playerId, playerType) {
    const selectedEmoji = document.getElementById('selected-emoji').textContent;
    
    console.log('Applying emoji change:', {playerName, playerId, playerType, selectedEmoji});
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                      document.querySelector('[name=csrf_token]')?.value || '';
    
    // Show loading state
    const applyBtn = event.target;
    const originalContent = applyBtn.innerHTML;
    applyBtn.disabled = true;
    applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichere...';
    
    const requestData = {
        team_id: {{ team.id }},
        player_name: playerName,
        emoji: selectedEmoji,
        player_type: playerType
    };
    
    console.log('Request data:', requestData);
    
    fetch('/admin/api/update_player_emoji', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Update the emoji in the main page
            const playerEmojiElement = document.querySelector(`#player-emoji-${playerId}`);
            if (playerEmojiElement) {
                // Emoji-Element existiert bereits, einfach aktualisieren
                playerEmojiElement.textContent = selectedEmoji;
                console.log('Updated emoji in DOM for player:', playerId);
            } else {
                // Emoji-Element existiert nicht (Spieler hat wahrscheinlich ein Profilbild)
                // Ersetze das Profilbild durch ein Emoji-Element
                const profileContainer = document.querySelector(`#player-row-${playerId} .profile-image-container`);
                if (profileContainer) {
                    // Bestimme die Border-Farbe basierend auf playerType
                    const borderColor = playerType === 'registration' ? '#007bff' : '#6c757d';
                    
                    // Erstelle das neue Emoji-Display
                    const emojiDisplay = `
                        <div class="emoji-display" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid ${borderColor}; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                            <span id="player-emoji-${playerId}" class="player-emoji" data-name="${playerName}">${selectedEmoji}</span>
                        </div>
                    `;
                    
                    // Finde das Bild-Element und ersetze es
                    const imgElement = profileContainer.querySelector('.player-profile-img');
                    if (imgElement) {
                        imgElement.outerHTML = emojiDisplay;
                        console.log('Replaced profile image with emoji for player:', playerId);
                    } else {
                        console.warn('Could not find profile image element for player:', playerId);
                    }
                } else {
                    console.warn('Could not find profile container for player:', playerId);
                }
            }
            
            showAlert('Emoji erfolgreich ge√§ndert!', 'success');
            closeImageEditModal();
        } else {
            console.error('Server error:', data.error);
            showAlert('Fehler beim √Ñndern des Emojis: ' + (data.error || 'Unbekannter Fehler'), 'danger');
        }
    })
    .catch(error => {
        console.error('Request error:', error);
        showAlert('Fehler beim √Ñndern des Emojis.', 'danger');
    })
    .finally(() => {
        applyBtn.disabled = false;
        applyBtn.innerHTML = originalContent;
    });
}

function openImageUpload(playerName, playerId, playerType) {
    document.getElementById('image-upload-area').style.display = 'block';
    document.getElementById('edit-camera-status').textContent = 'Klicke auf "Kamera starten" um ein neues Foto aufzunehmen.';
}

// Image capture functionality for edit modal
let editCameraStream = null;
let editCapturedImageData = null;

function startEditCamera() {
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'user',
            width: { ideal: 640, max: 1280 },
            height: { ideal: 640, max: 1280 }
        } 
    })
    .then(stream => {
        editCameraStream = stream;
        const video = document.getElementById('edit-camera-video');
        video.srcObject = stream;
        video.style.display = 'block';
        
        video.onloadedmetadata = function() {
            video.play();
            document.getElementById('edit-btn-start-camera').style.display = 'none';
            document.getElementById('edit-btn-take-photo').style.display = 'inline-block';
            document.getElementById('edit-camera-status').textContent = 'Kamera aktiv - Position dich gut und klicke auf "Foto aufnehmen".';
        };
    })
    .catch(error => {
        console.error('Camera error:', error);
        document.getElementById('edit-camera-status').innerHTML = 
            `<div style="color: #ff6b6b;">‚ùå Kamera konnte nicht gestartet werden: ${error.message}</div>`;
    });
}

function stopEditCamera() {
    if (editCameraStream) {
        editCameraStream.getTracks().forEach(track => track.stop());
        editCameraStream = null;
    }
}

function takeEditPhoto() {
    const video = document.getElementById('edit-camera-video');
    const canvas = document.getElementById('edit-camera-canvas');
    const capturedImg = document.getElementById('edit-camera-captured');
    
    canvas.width = 150;
    canvas.height = 150;
    
    const ctx = canvas.getContext('2d');
    
    // Clear and create circular clipping
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(75, 75, 75, 0, 2 * Math.PI);
    ctx.clip();
    
    // Mirror and draw video
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    
    editCapturedImageData = canvas.toDataURL('image/jpeg', 0.85);
    
    capturedImg.src = editCapturedImageData;
    capturedImg.style.display = 'block';
    video.style.display = 'none';
    
    document.getElementById('edit-btn-take-photo').style.display = 'none';
    document.getElementById('edit-btn-retake-photo').style.display = 'inline-block';
    document.getElementById('edit-btn-save-image').style.display = 'inline-block';
    
    document.getElementById('edit-camera-status').textContent = 'Foto aufgenommen! Gef√§llt es dir?';
    
    stopEditCamera();
}

function retakeEditPhoto() {
    document.getElementById('edit-camera-video').style.display = 'block';
    document.getElementById('edit-camera-captured').style.display = 'none';
    
    document.getElementById('edit-btn-retake-photo').style.display = 'none';
    document.getElementById('edit-btn-save-image').style.display = 'none';
    document.getElementById('edit-btn-start-camera').style.display = 'inline-block';
    
    editCapturedImageData = null;
    document.getElementById('edit-camera-status').textContent = 'Klicke auf "Kamera starten" um es nochmal zu versuchen.';
}

function savePlayerImage(playerName, playerId, playerType) {
    if (!editCapturedImageData) {
        showAlert('Kein Foto aufgenommen!', 'warning');
        return;
    }
    
    console.log('Saving player image:', {playerName, playerId, playerType});
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                      document.querySelector('[name=csrf_token]')?.value || '';
    
    // Show loading state
    const saveBtn = document.getElementById('edit-btn-save-image');
    const originalContent = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichere...';
    
    const requestData = {
        team_id: {{ team.id }},
        player_name: playerName,
        player_type: playerType,
        image_data: editCapturedImageData,
        action: 'upload'
    };
    
    console.log('Image request data:', requestData);
    
    fetch('/admin/api/update_player_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Image response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Image response data:', data);
        if (data.success) {
            showAlert('Profilbild erfolgreich aktualisiert!', 'success');
            closeImageEditModal();
            // Reload page to show updated image
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            console.error('Image server error:', data.error);
            showAlert('Fehler beim Speichern des Bildes: ' + (data.error || 'Unbekannter Fehler'), 'danger');
        }
    })
    .catch(error => {
        console.error('Image request error:', error);
        showAlert('Fehler beim Speichern des Bildes.', 'danger');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;
    });
}

function removePlayerImage(playerName, playerId, playerType) {
    if (!confirm(`Profilbild f√ºr "${playerName}" wirklich entfernen?`)) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                      document.querySelector('[name=csrf_token]')?.value || '';
    
    fetch('/admin/api/update_player_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            team_id: {{ team.id }},
            player_name: playerName,
            player_type: playerType,
            action: 'remove'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Profilbild erfolgreich entfernt!', 'success');
            closeImageEditModal();
            // Reload page to show emoji fallback
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Fehler beim Entfernen des Bildes: ' + (data.error || 'Unbekannter Fehler'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Fehler beim Entfernen des Bildes.', 'danger');
    });
}

// ESC key to close image edit modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('image-edit-modal')) {
        closeImageEditModal();
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopEditCamera();
});

// Bearbeitung f√ºr nachtr√§glich hinzugef√ºgte Team-Mitglieder
function editMemberName(playerName, playerId) {
    console.log('editMemberName called:', {playerName, playerId});
    try {
        // Zeige Input-Feld und verstecke Anzeige
        document.getElementById('player-name-' + playerId).classList.add('d-none');
        document.getElementById('player-name-input-' + playerId).classList.remove('d-none');
        
        // Zeige Save/Cancel Buttons und verstecke Edit Button
        document.getElementById('edit-btn-' + playerId).classList.add('d-none');
        document.getElementById('save-btn-' + playerId).classList.remove('d-none');
        document.getElementById('cancel-btn-' + playerId).classList.remove('d-none');
        
    } catch (error) {
        console.error('Error in editMemberName:', error);
    }
}

function saveMemberName(oldPlayerName, playerId) {
    const newName = document.getElementById('player-name-input-' + playerId).value.trim();
    
    if (newName.length < 2) {
        alert('Spielername muss mindestens 2 Zeichen lang sein.');
        return;
    }
    
    // AJAX Request zum Speichern (Team-Member Name √§ndern)
    fetch('/admin/update_team_member_name', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({
            team_id: {{ team.id }},
            old_player_name: oldPlayerName,
            new_player_name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aktualisiere Anzeige
            document.getElementById('player-name-' + playerId).textContent = newName;
            
            // Verstecke Input-Feld und zeige Anzeige
            document.getElementById('player-name-' + playerId).classList.remove('d-none');
            document.getElementById('player-name-input-' + playerId).classList.add('d-none');
            
            // Verstecke Save/Cancel Buttons und zeige Edit Button
            document.getElementById('edit-btn-' + playerId).classList.remove('d-none');
            document.getElementById('save-btn-' + playerId).classList.add('d-none');
            document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
            
            // Success-Meldung
            showAlert('Spielername erfolgreich aktualisiert.', 'success');
        } else {
            alert('Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern des Spielernamens.');
    });
}

function cancelMemberEdit(playerId) {
    try {
        // Verstecke Input-Feld und zeige Anzeige
        document.getElementById('player-name-' + playerId).classList.remove('d-none');
        document.getElementById('player-name-input-' + playerId).classList.add('d-none');
        
        // Verstecke Save/Cancel Buttons und zeige Edit Button
        document.getElementById('edit-btn-' + playerId).classList.remove('d-none');  
        document.getElementById('save-btn-' + playerId).classList.add('d-none');
        document.getElementById('cancel-btn-' + playerId).classList.add('d-none');
        
    } catch (error) {
        console.error('Error in cancelMemberEdit:', error);
    }
}
</script>

<!-- Modal f√ºr Spieler hinzuf√ºgen -->
<div id="add-player-modal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <button class="modal-close" onclick="closeAddPlayerModal()">&times;</button>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-dot active" id="add-player-step-dot-1"></div>
            <div class="step-dot" id="add-player-step-dot-2"></div>
        </div>
        
        <!-- Step 1: Name eingeben -->
        <div id="add-player-step-1" class="modal-step">
            <div class="modal-header">
                <h3 class="modal-title">üë• Spieler zu {{ team.name }} hinzuf√ºgen</h3>
                <p class="modal-subtitle">Trage den Namen des neuen Spielers ein!</p>
            </div>

            <div class="modal-form">
                <div class="form-group">
                    <label for="add-player-name" class="form-label">Spielername:</label>
                    <input type="text" id="add-player-name" class="form-input" placeholder="Gib den Namen ein..." maxlength="50" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-modal btn-modal-primary" onclick="proceedToAddPlayerCamera()">
                        <i class="fas fa-camera"></i> Weiter zum Foto
                    </button>
                    <button type="button" class="btn-modal btn-modal-secondary" onclick="closeAddPlayerModal()">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Camera -->
        <div id="add-player-step-2" class="modal-step camera-step" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">üì∏ Profilbild aufnehmen</h3>
                <p class="modal-subtitle">Nimm ein Foto f√ºr den Spieler auf!</p>
            </div>

            <div class="camera-preview">
                <video id="add-player-camera-video" class="camera-video" autoplay muted></video>
                <canvas id="add-player-camera-canvas" class="camera-canvas"></canvas>
                <img id="add-player-camera-captured" class="camera-captured" style="display: none;">
            </div>
            
            <div class="camera-controls">
                <button id="add-player-btn-start-camera" class="btn-camera btn-camera-capture" onclick="startAddPlayerCamera()">
                    <i class="fas fa-video"></i> Kamera starten
                </button>
                <button id="add-player-btn-take-photo" class="btn-camera btn-camera-capture" style="display: none;" onclick="takeAddPlayerPhoto()">
                    <i class="fas fa-camera"></i> Foto aufnehmen
                </button>
                <button id="add-player-btn-retake-photo" class="btn-camera btn-camera-retake" style="display: none;" onclick="retakeAddPlayerPhoto()">
                    <i class="fas fa-redo"></i> Nochmal
                </button>
                <button id="add-player-btn-save-and-add" class="btn-camera btn-camera-save" style="display: none;" onclick="savePhotoAndAddPlayer()">
                    <i class="fas fa-save"></i> Speichern & Hinzuf√ºgen
                </button>
                <button id="add-player-btn-skip-photo" class="btn-camera btn-camera-skip" onclick="skipPhotoAndAddPlayer()">
                    <i class="fas fa-forward"></i> Ohne Foto hinzuf√ºgen
                </button>
            </div>
            
            <div class="camera-status" id="add-player-camera-status">
                Klicke auf "Kamera starten" um ein Foto aufzunehmen.
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn-modal btn-modal-secondary" onclick="backToAddPlayerNameStep()">
                    <i class="fas fa-arrow-left"></i> Zur√ºck
                </button>
            </div>
        </div>

        <div id="add-player-status" class="add-player-status" style="display: none;">
            <span id="add-player-status-message"></span>
        </div>
    </div>
</div>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
    position: relative;
    color: white;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.modal-close:hover {
    opacity: 1;
}

.modal-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.modal-subtitle {
    opacity: 0.9;
    font-size: 1rem;
}

.modal-form {
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-input {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1rem;
    backdrop-filter: blur(10px);
}

.form-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.form-input:focus {
    outline: none;
    border-color: #FFD700;
    background: rgba(255, 255, 255, 0.2);
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-modal {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.btn-modal-primary {
    background: #FFD700;
    color: #333;
}

.btn-modal-primary:hover {
    background: #FFC107;
    transform: translateY(-2px);
}

.btn-modal-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-modal-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

/* √úbernehme die Kamera-Styles aus index.html */
.camera-preview {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 1rem auto;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.2);
}

.camera-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-canvas {
    display: none;
}

.camera-captured {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin: 1rem 0;
}

.btn-camera {
    padding: 0.6rem 1rem;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.btn-camera-capture {
    background: linear-gradient(45deg, #FF6B6B, #EE5A52);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
}

.btn-camera-capture:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 107, 0.5);
}

.btn-camera-retake {
    background: linear-gradient(45deg, #FFA726, #FF9800);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
}

.btn-camera-retake:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 167, 38, 0.5);
}

.btn-camera-save {
    background: linear-gradient(45deg, #4CAF50, #45A049);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.btn-camera-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
}

.btn-camera-skip {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-camera-skip:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.camera-status {
    margin: 0.5rem 0;
    font-size: 0.9rem;
    opacity: 0.9;
    min-height: 20px;
    text-align: center;
}

.step-indicator {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
}

.step-dot.active {
    background: #FFD700;
    transform: scale(1.2);
}

.add-player-status {
    text-align: center;
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 10px;
    display: none;
}

.status-success {
    background: rgba(76, 175, 80, 0.3);
    border: 1px solid rgba(76, 175, 80, 0.5);
}

.status-error {
    background: rgba(244, 67, 54, 0.3);
    border: 1px solid rgba(244, 67, 54, 0.5);
}

@media (max-width: 480px) {
    .modal-container {
        padding: 1.5rem;
        margin: 1rem;
    }
    
    .modal-buttons {
        flex-direction: column;
    }
}

/* Image Edit Modal Styles */
.modal-overlay-image-edit {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 11000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
}

.modal-container-image-edit {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border-radius: 20px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    position: relative;
    color: white;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease-out;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-close-image-edit {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.modal-close-image-edit:hover {
    opacity: 1;
}

.modal-header-image-edit {
    text-align: center;
    margin-bottom: 1.5rem;
}

.modal-title-image-edit {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.modal-subtitle-image-edit {
    opacity: 0.9;
    font-size: 1rem;
}

.modal-content-image-edit {
    margin-bottom: 1rem;
}

.current-display {
    text-align: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
}

.current-image-container {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

.current-emoji {
    font-size: 3rem;
    background: rgba(255, 255, 255, 0.2);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.edit-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.edit-section h4 {
    margin-bottom: 1rem;
    color: #ecf0f1;
    font-size: 1.2rem;
}

.emoji-picker {
    margin-bottom: 1rem;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
}

.emoji-button {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.emoji-button.selected {
    background: #3498db;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
}

.selected-emoji-display {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.selected-emoji {
    font-size: 2rem;
    background: rgba(255, 255, 255, 0.2);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-apply-emoji {
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: auto;
}

.btn-apply-emoji:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 204, 113, 0.4);
}

.image-options {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.btn-image-option {
    flex: 1;
    padding: 0.8rem 1rem;
    border: none;
    border-radius: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    background: linear-gradient(45deg, #3498db, #2980b9);
    color: white;
}

.btn-image-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
}

.btn-image-option.btn-remove {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
}

.btn-image-option.btn-remove:hover {
    box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
}

.image-upload-area {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
}

.camera-preview-edit {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 1rem auto;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.3);
}

.camera-video-edit {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

.camera-canvas-edit {
    display: none;
}

.camera-captured-edit {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-controls-edit {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin: 1rem 0;
}

.btn-camera-edit {
    padding: 0.6rem 1rem;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.btn-camera-capture-edit {
    background: linear-gradient(45deg, #FF6B6B, #EE5A52);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
}

.btn-camera-capture-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 107, 0.5);
}

.btn-camera-retake-edit {
    background: linear-gradient(45deg, #FFA726, #FF9800);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
}

.btn-camera-retake-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 167, 38, 0.5);
}

.btn-camera-save-edit {
    background: linear-gradient(45deg, #4CAF50, #45A049);
    color: white;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
}

.btn-camera-save-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
}

.camera-status-edit {
    margin: 0.5rem 0;
    font-size: 0.9rem;
    opacity: 0.9;
    min-height: 20px;
    text-align: center;
}

.modal-buttons-image-edit {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-modal-secondary-edit {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-modal-secondary-edit:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

@media (max-width: 480px) {
    .modal-container-image-edit {
        padding: 1.5rem;
        margin: 1rem;
    }
    
    .emoji-grid {
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        gap: 0.3rem;
    }
    
    .emoji-button {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }
    
    .image-options {
        flex-direction: column;
    }
    
    .camera-controls-edit {
        flex-direction: column;
    }
}
</style>
{% endblock %}