{% extends "base.html" %}

{% block title %}Moderationsmodus - Wii Party U Deluxe{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Admin Moderation Mode Theme - Dark Professional */
    .moderation-container {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        min-height: 100vh;
        color: white;
        position: relative;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .moderation-container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(52, 73, 94, 0.1) 25%, transparent 25%),
                    linear-gradient(-45deg, rgba(52, 73, 94, 0.1) 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, rgba(52, 73, 94, 0.1) 75%),
                    linear-gradient(-45deg, transparent 75%, rgba(52, 73, 94, 0.1) 75%);
        background-size: 60px 60px;
        background-position: 0 0, 0 30px, 30px -30px, -30px 0px;
        animation: movePattern 20s linear infinite;
        opacity: 0.1;
        z-index: -1;
        pointer-events: none;
    }

    @keyframes movePattern {
        0% { transform: translateX(0px) translateY(0px); }
        100% { transform: translateX(60px) translateY(60px); }
    }

    .moderation-content {
        position: relative;
        z-index: 2;
        padding: 1rem 0;
        min-height: 100vh;
    }

    .moderation-header {
        background: rgba(44, 62, 80, 0.2);
        border-radius: 20px;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .moderation-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0;
        background: linear-gradient(45deg, #ecf0f1, #bdc3c7, #ecf0f1);
        background-size: 200% 200%;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Card styling with dark theme */
    .card {
        background: rgba(44, 62, 80, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 18px !important;
        backdrop-filter: blur(15px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        color: white !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.2) !important;
    }

    .card-header {
        background: rgba(231, 76, 60, 0.2) !important;
        border-bottom: 1px solid rgba(231, 76, 60, 0.3) !important;
        border-radius: 18px 18px 0 0 !important;
        padding: 1.5rem 2rem !important;
        color: white !important;
    }

    .card-header.bg-success {
        background: rgba(39, 174, 96, 0.2) !important;
        border-bottom: 1px solid rgba(39, 174, 96, 0.3) !important;
    }

    .card-header.bg-primary {
        background: rgba(52, 152, 219, 0.2) !important;
        border-bottom: 1px solid rgba(52, 152, 219, 0.3) !important;
    }

    .card-header.bg-warning {
        background: rgba(241, 196, 15, 0.2) !important;
        border-bottom: 1px solid rgba(241, 196, 15, 0.3) !important;
    }

    .card-header.bg-info {
        background: rgba(26, 188, 156, 0.2) !important;
        border-bottom: 1px solid rgba(26, 188, 156, 0.3) !important;
    }

    .card-body {
        padding: 2rem !important;
        color: white !important;
        background: transparent !important;
    }

    .card-title {
        color: white !important;
        font-weight: 600;
    }

    .card-text {
        color: rgba(255, 255, 255, 0.9) !important;
    }

    /* Badge styling */
    .badge {
        border-radius: 15px;
        padding: 0.5rem 0.8rem;
        font-weight: 600;
    }

    .badge-lg {
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
    }

    .badge-info {
        background: linear-gradient(45deg, #3498db, #2980b9) !important;
    }

    .badge-primary {
        background: linear-gradient(45deg, #3498db, #2980b9) !important;
    }

    .badge-secondary {
        background: rgba(149, 165, 166, 0.8) !important;
    }

    .badge-success {
        background: linear-gradient(45deg, #27ae60, #229954) !important;
    }

    .badge-warning {
        background: linear-gradient(45deg, #f1c40f, #f39c12) !important;
        color: #2c3e50 !important;
    }

    .badge-danger {
        background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
    }

    .badge-light {
        background: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }

    /* Button styling */
    .btn {
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d) !important;
        color: white !important;
        box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
    }

    .btn-secondary:hover {
        background: linear-gradient(45deg, #7f8c8d, #6c7b7d) !important;
        color: white !important;
        box-shadow: 0 8px 20px rgba(149, 165, 166, 0.4);
    }

    .btn-outline-info {
        border: 2px solid #1abc9c !important;
        color: #1abc9c !important;
        background: transparent !important;
    }

    .btn-outline-info:hover {
        background: #1abc9c !important;
        color: white !important;
        box-shadow: 0 5px 15px rgba(26, 188, 156, 0.3);
    }

    /* Progress bar styling */
    .progress {
        background: rgba(44, 62, 80, 0.3) !important;
        border-radius: 10px;
        overflow: hidden;
        height: 1.5rem;
    }

    .progress-bar {
        background: linear-gradient(45deg, #3498db, #2980b9) !important;
        border-radius: 10px;
    }

    .progress-bar.bg-info {
        background: linear-gradient(45deg, #1abc9c, #16a085) !important;
    }

    /* Alert styling */
    .alert {
        border: none !important;
        border-radius: 10px !important;
        backdrop-filter: blur(10px);
        border-left: 4px solid;
        color: white !important;
    }

    .alert-success {
        background: rgba(39, 174, 96, 0.15) !important;
        color: #a8e6cf !important;
        border-left-color: #27ae60 !important;
    }

    .alert-info {
        background: rgba(52, 152, 219, 0.15) !important;
        color: #a8d8ea !important;
        border-left-color: #3498db !important;
    }

    /* Text colors */
    .text-warning {
        color: #f39c12 !important;
    }

    .text-muted {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    .text-primary {
        color: #3498db !important;
    }

    .text-success {
        color: #27ae60 !important;
    }

    .text-danger {
        color: #e74c3c !important;
    }

    /* Dice display styling */
    .dice-display {
        text-align: center;
        padding: 1rem;
        background: rgba(44, 62, 80, 0.1);
        border-radius: 10px;
        margin: 0.5rem 0;
    }

    .dice-display .h1, .dice-display .h2, .dice-display .h4 {
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: white;
    }

    #dice-result-display {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #dice-result-display.fade-out {
        animation: fadeOut 0.5s ease-out;
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .moderation-content .container-fluid {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .moderation-header {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .moderation-header h1 {
            font-size: 2rem;
        }

        .card-body {
            padding: 1.5rem !important;
        }

        .card-header {
            padding: 1rem 1.5rem !important;
        }

        .dice-display {
            padding: 0.8rem;
        }
        
        .dice-display .h1, .dice-display .h2, .dice-display .h4 {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .btn {
            font-size: 0.875rem;
            padding: 0.6rem 1.2rem;
        }
    }

    @media (max-width: 576px) {
        .moderation-header {
            padding: 1rem;
        }

        .moderation-header .d-flex {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="moderation-container">
    <div class="moderation-content">
        <div class="container-fluid">
            <div class="moderation-header">
                <!-- Desktop: Titel und Button nebeneinander -->
                <div class="d-none d-md-flex justify-content-between align-items-center">
                    <h1>Moderationsmodus</h1>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Zur√ºck zum Admin Dashboard
                    </a>
                </div>
                
                <!-- Mobile: Nur Titel -->
                <div class="d-md-none">
                    <h1>Moderationsmodus</h1>
                </div>
            </div>
    
    <!-- Aktueller Spielstatus -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-eye"></i> Aktueller Spielstatus</h5>
                </div>
                <div class="card-body">
                    {% if game_status %}
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Status:</strong>
                                <span class="badge badge-{{ game_status.status_color }} badge-lg">
                                    {{ game_status.current_status }}
                                </span>
                            </div>
                            
                            {% if game_status.current_team %}
                            <div class="col-md-3">
                                <strong>Aktuelles Team:</strong>
                                <span class="badge badge-primary">{{ game_status.current_team }}</span>
                            </div>
                            {% endif %}
                            
                            
                        </div>
                        
                        {% if game_status.additional_info %}
                        <div class="mt-3">
                            <strong>Details:</strong>
                            <p class="mb-0">{{ game_status.additional_info }}</p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-pause-circle fa-3x mb-3"></i>
                            <p>Spiel ist momentan nicht aktiv</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- W√úRFELRUNDEN-ERGEBNISSE -->
    <div class="row mb-5" id="dice-round-results" style="display: none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dice-six"></i> 
                        W√ºrfelrunden-Ergebnisse
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="dice-results-container">
                        <!-- Wird per JavaScript bef√ºllt -->
                        <div class="col-12 text-center text-muted">
                            <i class="fas fa-clock"></i> Warte auf W√ºrfelergebnisse...
                        </div>
                    </div>
                    <div class="mt-3" id="dice-round-summary" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-trophy"></i> H√∂chster Wurf:</h6>
                                <span id="highest-roll" class="badge badge-success badge-lg">-</span>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-bar"></i> Durchschnitt:</h6>
                                <span id="average-roll" class="badge badge-info badge-lg">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailansicht f√ºr Fragen/Minigames oder Ergebnisse -->
    <!-- IMMER RENDERN aber anfangs versteckt -->
    <div class="row mb-5" id="initial-content-card" style="{% if not (game_status and (game_status.content_details or (game_status.results and game_status.results.has_results))) %}display: none;{% endif %}">
        <div class="col-12">
            <div id="content-card-inner">
                {% if game_status and game_status.content_details %}
                <div class="card border-{{ game_status.content_details.type_color }}">
                    <div class="card-header bg-{{ game_status.content_details.type_color }} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-{{ game_status.content_details.icon }}"></i> 
                            {{ game_status.content_details.type_name }}: {{ game_status.content_details.name }}
                        </h5>
                    </div>
                {% elif game_status and game_status.results and game_status.results.has_results %}
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> 
                            Letzte Ergebnisse
                        </h5>
                    </div>
                {% else %}
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> 
                            Inhalt
                        </h5>
                    </div>
                {% endif %}
                <div class="card-body">
                    {% if game_status.content_details %}
                        {% if game_status.content_details.description %}
                            <p><strong>Beschreibung:</strong> {{ game_status.content_details.description }}</p>
                        {% endif %}
                        
                        {% if game_status.content_details.question_text %}
                            <div class="mb-3">
                                <strong>Frage:</strong>
                                <p class="h5 text-primary">{{ game_status.content_details.question_text }}</p>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.options %}
                            <div class="mb-3">
                                <strong>Antwortm√∂glichkeiten:</strong>
                                <div class="row">
                                    {% for option in game_status.content_details.options %}
                                    <div class="col-md-6 mb-2">
                                        <span class="badge badge-light badge-lg">{{ loop.index }}. {{ option }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.correct_answer %}
                            <div class="alert alert-success">
                                <strong>Korrekte Antwort:</strong> {{ game_status.content_details.correct_answer }}
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.duration %}
                            <p><strong>Dauer:</strong> {{ game_status.content_details.duration }}</p>
                        {% endif %}
                        
                        {% if game_status.content_details.instructions %}
                            <div class="alert alert-info">
                                <strong>Anweisungen:</strong> {{ game_status.content_details.instructions }}
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.selected_players %}
                            <div class="mb-3">
                                <strong>Ausgeloste Spieler:</strong>
                                <div class="row">
                                    {% for team_name, player_name in game_status.content_details.selected_players.items() %}
                                    <div class="col-md-4 mb-2">
                                        <div class="card border-primary">
                                            <div class="card-body p-2">
                                                <strong>{{ team_name }}:</strong><br>
                                                <span class="text-primary">{{ player_name }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if game_status.content_details.team_responses %}
                            <div class="mb-3">
                                <strong>Team-Antworten:</strong>
                                <div id="team-responses-section">
                                    {% if game_status.content_details.team_responses.detailed_responses %}
                                        <div class="mt-2">
                                            <small class="text-muted">{{ game_status.content_details.team_responses.total_responses }}/{{ game_status.content_details.team_responses.total_teams }} Teams haben geantwortet</small>
                                        </div>
                                        <div class="row mt-2">
                                            {% for response in game_status.content_details.team_responses.detailed_responses %}
                                            <div class="col-md-6 mb-2">
                                                <div class="card border-{% if response.is_correct %}success{% else %}danger{% endif %}">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>{{ response.team_name }}</strong>
                                                                <small class="d-block text-muted">{{ response.answer_preview }}</small>
                                                                {% if response.answered_at %}
                                                                    <small class="text-muted">{{ response.answered_at }}</small>
                                                                {% endif %}
                                                            </div>
                                                            <span>
                                                                {% if response.is_correct %}
                                                                    <i class="fas fa-check text-success"></i>
                                                                {% else %}
                                                                    <i class="fas fa-times text-danger"></i>
                                                                {% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% if game_status.content_details.team_responses.total_responses == game_status.content_details.team_responses.total_teams and game_status.content_details.team_responses.total_teams > 0 %}
                                            <div class="alert alert-success mt-2 mb-0">
                                                <i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="row mt-2">
                                            <div class="col-md-6">
                                                <h6 class="text-success">‚úì Geantwortet:</h6>
                                                {% if game_status.content_details.team_responses.answered %}
                                                    {% for team in game_status.content_details.team_responses.answered %}
                                                    <span class="badge badge-success mr-1 mb-1">{{ team }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">Noch keine Antworten</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-warning">‚è≥ Ausstehend:</h6>
                                                {% if game_status.content_details.team_responses.pending %}
                                                    {% for team in game_status.content_details.team_responses.pending %}
                                                    <span class="badge badge-warning mr-1 mb-1">{{ team }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">Alle haben geantwortet</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if game_status.results and game_status.results.has_results %}
                        <div class="mb-3">
                            <strong>üèÜ Platzierungen:</strong>
                            <div class="row">
                                {% for result in game_status.results.placements %}
                                <div class="col-md-4 mb-2">
                                    <div class="card border-{% if result.placement == 1 %}warning{% elif result.placement == 2 %}secondary{% elif result.placement == 3 %}info{% else %}light{% endif %}">
                                        <div class="card-body p-2 text-center">
                                            <div class="h4 mb-1">
                                                {% if result.placement == 1 %}ü•á
                                                {% elif result.placement == 2 %}ü•à
                                                {% elif result.placement == 3 %}ü•â
                                                {% else %}{{ result.placement }}.{% endif %}
                                            </div>
                                            <strong>{{ result.team_name }}</strong>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- AKTIVER ABLAUFPLAN - IMMER SICHTBAR -->
    <div class="row mb-5" id="sequence-info-display">
        <div class="col-12">
            <div class="card border-info shadow-sm" style="margin: 0 15px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol"></i> 
                        Aktiver Ablaufplan: {% if sequence_info %}{{ sequence_info.name }}{% else %}Wird geladen...{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>Fortschritt</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-info" id="sequence-progress-bar"
                                     style="width: {% if sequence_info %}{{ sequence_info.progress_percentage }}{% else %}0{% endif %}%">
                                    {% if sequence_info %}{{ sequence_info.progress_percentage }}{% else %}0{% endif %}%
                                </div>
                            </div>
                            <small class="text-muted" id="sequence-position-text">
                                {% if sequence_info %}{{ sequence_info.current_position + 1 }} von {{ sequence_info.total_items }} abgeschlossen{% else %}Lade Informationen...{% endif %}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <div class="text-right">
                                {% if sequence_info and sequence_info.current_item %}
                                    <h6 class="text-warning">
                                        <i class="fas fa-play"></i> Aktuell:
                                    </h6>
                                    <div class="card border-warning">
                                        <div class="card-body p-2">
                                            {% if sequence_info.current_item.type == 'minigame' %}
                                                <i class="fas fa-gamepad text-primary"></i>
                                            {% else %}
                                                <i class="fas fa-question-circle text-info"></i>
                                            {% endif %}
                                            <strong>{{ sequence_info.current_item.name }}</strong>
                                        </div>
                                    </div>
                                {% else %}
                                    <h6 class="text-muted">
                                        <i class="fas fa-clock"></i> Wird geladen...
                                    </h6>
                                {% endif %}
                                
                                {% if sequence_info and sequence_info.next_item %}
                                    <h6 class="text-muted mt-3">
                                        <i class="fas fa-step-forward"></i> Als n√§chstes:
                                    </h6>
                                    <div class="card border-light">
                                        <div class="card-body p-2">
                                            {% if sequence_info.next_item.type == 'minigame' %}
                                                <i class="fas fa-gamepad text-primary"></i>
                                            {% else %}
                                                <i class="fas fa-question-circle text-info"></i>
                                            {% endif %}
                                            <strong>{{ sequence_info.next_item.name }}</strong>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vollst√§ndige Sequenz-Liste -->
                    <div class="collapse" id="full-sequence-list">
                        <hr>
                        <h6><i class="fas fa-list"></i> Vollst√§ndiger Ablaufplan:</h6>
                        <div class="row">
                            {% if sequence_info and sequence_info.sequence_list %}
                                {% for item in sequence_info.sequence_list %}
                                <div class="col-md-4 mb-2">
                                    <div class="card border-{% if loop.index0 < sequence_info.current_position %}success{% elif loop.index0 == sequence_info.current_position %}warning{% else %}light{% endif %}">
                                        <div class="card-body p-2">
                                            <div class="d-flex align-items-center">
                                                <span class="badge badge-primary mr-2">{{ loop.index }}</span>
                                                {% if item.type == 'minigame' %}
                                                    <i class="fas fa-gamepad text-primary mr-1"></i>
                                                {% else %}
                                                    <i class="fas fa-question-circle text-info mr-1"></i>
                                                {% endif %}
                                                <small class="flex-grow-1">{{ item.name }}</small>
                                                {% if loop.index0 < sequence_info.current_position %}
                                                    <i class="fas fa-check text-success"></i>
                                                {% elif loop.index0 == sequence_info.current_position %}
                                                    <i class="fas fa-play text-warning"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12 text-center text-muted">
                                    <i class="fas fa-clock"></i> Lade Ablaufplan...
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-info btn-sm" type="button" data-toggle="collapse" data-target="#full-sequence-list">
                            <i class="fas fa-list"></i> Vollst√§ndigen Plan anzeigen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- W√úRFELERGEBNIS-ANZEIGE - LIVE UPDATES -->
    <div class="row mb-4" id="dice-result-display" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dice"></i> 
                        W√ºrfelergebnis
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Team</small>
                                <div class="h4" id="dice-team-name">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Standard</small>
                                <div class="h2 text-primary" id="dice-standard">-</div>
                            </div>
                        </div>
                        <div class="col-md-3" id="dice-bonus-section" style="display: none;">
                            <div class="dice-display">
                                <small class="text-muted">Bonus</small>
                                <div class="h2 text-warning" id="dice-bonus">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dice-display">
                                <small class="text-muted">Gesamt</small>
                                <div class="h1 text-success font-weight-bold" id="dice-total">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="dice-timestamp">Zeit: --:--:--</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Mobile: Zur√ºck-Button am Ende der Seite -->
    <div class="row mt-5 d-block d-md-none">
        <div class="col-12 text-center">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Zur√ºck zum Admin Dashboard
            </a>
        </div>
    </div>
    
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastPhase = null;
    let diceResultTimeout = null;
    let lastDiceResult = null;
    let diceRoundResults = []; // Sammelt alle W√ºrfelergebnisse der aktuellen Runde
    let diceRoundHideTimeout = null; // Timeout zum automatischen Verstecken
    let processedTeams = new Set(); // Teams die bereits gew√ºrfelt haben
    
    // AJAX Auto-Update alle 3 Sekunden - VEREINFACHT UND ROBUSTER
    function updateStatus() {
        fetch('{{ url_for("admin.moderation_mode_api") }}')
            .then(response => response.json())
            .then(data => {
                console.log('Update data received:', data);
                
                if (data.game_status) {
                    // Erkenne Phasenwechsel
                    const currentPhase = data.game_status.current_status;
                    if (lastPhase && lastPhase !== currentPhase) {
                        console.log(`Phase changed from ${lastPhase} to ${currentPhase}`);
                        handlePhaseChange(lastPhase, currentPhase);
                    }
                    lastPhase = currentPhase;
                    
                    updateStatusSection(data.game_status);
                    updateContentSection(data.game_status);
                    
                    // Debug dice result data
                    console.log('Dice result in game_status:', data.game_status.dice_result);
                    updateDiceResultSection(data.game_status);
                } else {
                    showInactiveGame();
                }
                
                // Update Sequenz-Informationen
                updateSequenceSection(data.sequence_info);
            })
            .catch(error => {
                console.error('Update failed:', error);
            });
    }
    
    function handlePhaseChange(oldPhase, newPhase) {
        const contentPhases = ['Frage l√§uft', 'Frage', 'Minispiel', 'Ergebnisse', 'Runde beendet'];
        const wasContentPhase = contentPhases.includes(oldPhase);
        const isContentPhase = contentPhases.includes(newPhase);
        
        // Wenn von Content-Phase zu W√ºrfelrunde gewechselt wird, blende Content aus
        if (wasContentPhase && newPhase === 'W√ºrfelrunde') {
            console.log('Hiding content due to phase change to dice rolling');
            hideContentCard();
        }
        
        // W√ºrfelrunden-Management
        if (newPhase === 'W√ºrfelrunde' && oldPhase !== 'W√ºrfelrunde') {
            console.log('Starting new dice round - clearing previous results');
            clearDiceRoundResults();
        }
        
        // L√∂sche auch bei allen anderen Phasenwechseln (au√üer innerhalb W√ºrfelrunde)
        if (oldPhase === 'W√ºrfelrunde' && newPhase !== 'W√ºrfelrunde') {
            console.log('Left dice rolling phase - clearing dice results');
            clearDiceRoundResults();
        }
        
        // Wenn von Ergebnissen zu neuer Frage/Minispiel gewechselt wird, r√§ume auf
        if ((oldPhase === 'Ergebnisse' || oldPhase === 'Runde beendet') && isContentPhase && newPhase !== 'Ergebnisse' && newPhase !== 'Runde beendet') {
            console.log('Clearing old results due to new content');
            clearContentCard();
        }
        
        // Wenn zu Content-Phase gewechselt wird, stelle sicher dass Content angezeigt wird
        if (!wasContentPhase && isContentPhase) {
            console.log('Switching to content phase, ensuring content is visible');
            // Lass updateContentSection das handhaben
        }
        
        // W√ºrfelergebnis bei Phasenwechsel von W√ºrfelrunde weg - VERL√ÑNGERTE ANZEIGE
        if (oldPhase === 'W√ºrfelrunde' && newPhase !== 'W√ºrfelrunde') {
            console.log('Phase changed away from dice rolling - extending dice result display for 10 seconds');
            
            // L√∂sche vorherigen Timeout
            if (diceResultTimeout) {
                clearTimeout(diceResultTimeout);
            }
            
            // Verl√§ngerte Anzeige f√ºr 10 Sekunden nach Ende der W√ºrfelrunde
            diceResultTimeout = setTimeout(() => {
                console.log('Hiding dice result after extended display (10 seconds)');
                hideDiceResult();
            }, 10000);
        }
    }
    
    function hideContentCard() {
        const contentCard = document.querySelector('#initial-content-card');
        if (contentCard) {
            contentCard.style.display = 'none';
        }
    }
    
    function clearContentCard() {
        const contentCard = document.querySelector('#initial-content-card');
        if (contentCard) {
            // Entferne alte Ergebnisse
            const resultsSection = contentCard.querySelector('.results-section');
            if (resultsSection) {
                resultsSection.remove();
            }
            
            // Setze Team-Antworten zur√ºck
            const responsesSection = contentCard.querySelector('#team-responses-section');
            if (responsesSection) {
                responsesSection.innerHTML = '<div class="text-center text-muted"><i class="fas fa-clock"></i> Warte auf Antworten...</div>';
            }
        }
    }
    
    function updateStatusSection(gameStatus) {
        // Update Status Badge
        const statusBadge = document.querySelector('.badge-lg');
        if (statusBadge) {
            statusBadge.className = `badge badge-${gameStatus.status_color} badge-lg`;
            statusBadge.textContent = gameStatus.current_status;
        }
        
        // Update Team Info
        const teamCol = document.querySelector('.col-md-3:nth-child(2)');
        if (teamCol) {
            if (gameStatus.current_team) {
                teamCol.innerHTML = `<strong>Aktuelles Team:</strong>
                    <span class="badge badge-primary">${gameStatus.current_team}</span>`;
            } else {
                teamCol.innerHTML = '';
            }
        }
        
        // Update Details
        const detailsDiv = document.querySelector('.mt-3 p');
        if (detailsDiv && gameStatus.additional_info) {
            detailsDiv.textContent = gameStatus.additional_info;
        }
    }
    
    function updateContentSection(gameStatus) {
        const contentCard = document.querySelector('#initial-content-card');
        const currentPhase = gameStatus.current_status;
        
        // Zeige Content bei allen relevanten Phasen - ERWEITERT UM "RUNDE BEENDET"
        const showContentPhases = ['Frage l√§uft', 'Frage', 'Minispiel', 'Ergebnisse', 'Runde beendet'];
        const shouldShowContent = showContentPhases.includes(currentPhase) && 
                                 (gameStatus.content_details || (gameStatus.results && gameStatus.results.has_results));
        
        console.log(`Phase: ${currentPhase}, Should show content: ${shouldShowContent}, Has content_details: ${!!gameStatus.content_details}, Has results: ${!!(gameStatus.results && gameStatus.results.has_results)}`);
        
        if (shouldShowContent) {
            if (contentCard) {
                contentCard.style.display = 'block';
                console.log('Showing content card - display set to block');
                
                // Update the entire content card
                updateContentCardContent(gameStatus);
            } else {
                console.error('Content card element not found! Creating or showing content...');
                ensureContentCardExists(gameStatus);
            }
        } else {
            // Verstecke Content nur bei W√ºrfelrunde oder wirklich unbekannten Phasen
            if (contentCard && currentPhase === 'W√ºrfelrunde') {
                console.log(`Hiding content card for phase: ${currentPhase}`);
                contentCard.style.display = 'none';
            }
        }
    }
    
    function ensureContentCardExists(gameStatus) {
        // Pr√ºfe ob das initial content card existiert aber versteckt ist
        let contentCard = document.querySelector('#initial-content-card');
        
        if (!contentCard) {
            console.log('Initial content card not found, checking template...');
            return;
        }
        
        // Force show the content card
        contentCard.style.display = 'block';
        contentCard.style.visibility = 'visible';
        
        console.log('Content card forced to show');
        
        // Rebuild the content card inner HTML dynamically
        updateContentCardContent(gameStatus);
    }
    
    function updateContentCardContent(gameStatus) {
        const contentInner = document.querySelector('#content-card-inner');
        if (!contentInner) return;
        
        let html = '';
        
        if (gameStatus.content_details) {
            html = `
                <div class="card border-${gameStatus.content_details.type_color}">
                    <div class="card-header bg-${gameStatus.content_details.type_color} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-${gameStatus.content_details.icon}"></i> 
                            ${gameStatus.content_details.type_name}: ${gameStatus.content_details.name}
                        </h5>
                    </div>
                    <div class="card-body">
                        ${gameStatus.content_details.description ? `<p><strong>Beschreibung:</strong> ${gameStatus.content_details.description}</p>` : ''}
                        ${gameStatus.content_details.question_text ? `<div class="mb-3"><strong>Frage:</strong><p class="h5 text-primary">${gameStatus.content_details.question_text}</p></div>` : ''}
                        ${gameStatus.content_details.options ? generateOptionsHTML(gameStatus.content_details.options) : ''}
                        ${gameStatus.content_details.correct_answer ? `<div class="alert alert-success"><strong>Korrekte Antwort:</strong> ${gameStatus.content_details.correct_answer}</div>` : ''}
                        ${gameStatus.content_details.duration ? `<p><strong>Dauer:</strong> ${gameStatus.content_details.duration}</p>` : ''}
                        ${gameStatus.content_details.instructions ? `<div class="alert alert-info"><strong>Anweisungen:</strong> ${gameStatus.content_details.instructions}</div>` : ''}
                        ${gameStatus.content_details.selected_players ? generatePlayersHTML(gameStatus.content_details.selected_players) : ''}
                        ${gameStatus.content_details.team_responses ? generateResponsesHTML(gameStatus.content_details.team_responses) : ''}
                    </div>
                </div>
            `;
        } else if (gameStatus.results && gameStatus.results.has_results) {
            html = `
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> 
                            Ergebnisse
                        </h5>
                    </div>
                    <div class="card-body">
                        ${generateResultsHTML(gameStatus.results)}
                    </div>
                </div>
            `;
        }
        
        contentInner.innerHTML = html;
        console.log('Content card inner HTML updated');
    }
    
    function generateOptionsHTML(options) {
        if (!options || options.length === 0) return '';
        let html = '<div class="mb-3"><strong>Antwortm√∂glichkeiten:</strong><div class="row">';
        options.forEach((option, index) => {
            html += `<div class="col-md-6 mb-2"><span class="badge badge-light badge-lg">${index + 1}. ${option}</span></div>`;
        });
        html += '</div></div>';
        return html;
    }
    
    function generatePlayersHTML(players) {
        if (!players || Object.keys(players).length === 0) return '';
        let html = '<div class="mb-3"><strong>Ausgeloste Spieler:</strong><div class="row">';
        Object.entries(players).forEach(([teamName, playerName]) => {
            html += `<div class="col-md-4 mb-2"><div class="card border-primary"><div class="card-body p-2"><strong>${teamName}:</strong><br><span class="text-primary">${playerName}</span></div></div></div>`;
        });
        html += '</div></div>';
        return html;
    }
    
    function generateResponsesHTML(responses) {
        if (!responses) return '';
        
        if (responses.detailed_responses && responses.detailed_responses.length > 0) {
            let html = `<div class="mb-3" id="team-responses-section">
                <strong>Team-Antworten:</strong>
                <div class="mt-2">
                    <small class="text-muted">${responses.total_responses}/${responses.total_teams} Teams haben geantwortet</small>
                </div>
                <div class="row mt-2">`;
            
            responses.detailed_responses.forEach(response => {
                const borderClass = response.is_correct ? 'success' : 'danger';
                const icon = response.is_correct ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-${borderClass}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${response.team_name}</strong>
                                        <small class="d-block text-muted">${response.answer_preview}</small>
                                        ${response.answered_at ? `<small class="text-muted">${response.answered_at}</small>` : ''}
                                    </div>
                                    <span><i class="${icon}"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (responses.total_responses === responses.total_teams && responses.total_teams > 0) {
                html += '<div class="alert alert-success mt-2 mb-0"><i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Fallback zu einfacher Anzeige
        let html = '<div class="mb-3"><strong>Team-Antworten:</strong><div class="row">';
        html += '<div class="col-md-6"><h6 class="text-success">‚úì Geantwortet:</h6>';
        if (responses.answered && responses.answered.length > 0) {
            responses.answered.forEach(team => {
                html += `<span class="badge badge-success mr-1 mb-1">${team}</span>`;
            });
        } else {
            html += '<span class="text-muted">Noch keine Antworten</span>';
        }
        html += '</div><div class="col-md-6"><h6 class="text-warning">‚è≥ Ausstehend:</h6>';
        if (responses.pending && responses.pending.length > 0) {
            responses.pending.forEach(team => {
                html += `<span class="badge badge-warning mr-1 mb-1">${team}</span>`;
            });
        } else {
            html += '<span class="text-muted">Alle haben geantwortet</span>';
        }
        html += '</div></div></div>';
        return html;
    }
    
    function updateTeamResponses(teamResponses) {
        const responsesSection = document.querySelector('#team-responses-section');
        if (!responsesSection) return;
        
        if (teamResponses.detailed_responses && teamResponses.detailed_responses.length > 0) {
            let html = `<div class="mt-2">
                <small class="text-muted">${teamResponses.total_responses}/${teamResponses.total_teams} Teams haben geantwortet</small>
            </div>
            <div class="row mt-2">`;
            
            teamResponses.detailed_responses.forEach(response => {
                const borderClass = response.is_correct ? 'success' : 'danger';
                const icon = response.is_correct ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card border-${borderClass}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${response.team_name}</strong>
                                        <small class="d-block text-muted">${response.answer_preview}</small>
                                        ${response.answered_at ? `<small class="text-muted">${response.answered_at}</small>` : ''}
                                    </div>
                                    <span><i class="${icon}"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (teamResponses.total_responses === teamResponses.total_teams && teamResponses.total_teams > 0) {
                html += '<div class="alert alert-success mt-2 mb-0"><i class="fas fa-check-circle"></i> Alle Teams haben geantwortet!</div>';
            }
            
            responsesSection.innerHTML = html;
        }
    }
    
    function updateResults(results) {
        // Pr√ºfe ob bereits statische Ergebnisse da sind
        const cardBody = document.querySelector('#initial-content-card .card-body');
        if (!cardBody) return;
        
        const staticResults = cardBody.innerHTML.includes('üèÜ Platzierungen');
        if (!staticResults && results.placements && results.placements.length > 0) {
            // Entferne alte dynamische Ergebnisse
            const oldResults = cardBody.querySelector('.results-section');
            if (oldResults) {
                oldResults.remove();
            }
            
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'mb-3 results-section';
            resultsDiv.innerHTML = generateResultsHTML(results);
            cardBody.appendChild(resultsDiv);
        }
    }
    
    function showInactiveGame() {
        const statusCard = document.querySelector('.card-body');
        if (statusCard) {
            statusCard.innerHTML = `<div class="text-center text-muted py-4">
                <i class="fas fa-pause-circle fa-3x mb-3"></i>
                <p>Spiel ist momentan nicht aktiv</p>
            </div>`;
        }
        hideDiceResult();
    }
    
    function isRecentDiceResult(diceResult) {
        // Pr√ºfe ob das W√ºrfelergebnis wirklich recent ist (maximal 10 Sekunden alt)
        try {
            const now = new Date();
            const timestamp = diceResult.timestamp; // Format: "HH:MM:SS"
            
            // Parse timestamp (heute + timestamp)
            const [hours, minutes, seconds] = timestamp.split(':').map(Number);
            const diceTime = new Date();
            diceTime.setHours(hours, minutes, seconds, 0);
            
            // Wenn das W√ºrfelergebnis von gestern ist (aber gleiche Uhrzeit heute)
            // dann ist es definitiv alt
            const timeDiff = Math.abs(now - diceTime);
            const isRecent = timeDiff <= 10000; // Maximal 10 Sekunden alt
            
            console.log(`Dice result time check: ${timestamp}, diff: ${timeDiff}ms, isRecent: ${isRecent}`);
            return isRecent;
            
        } catch (error) {
            console.error('Error checking dice result time:', error);
            return false; // Bei Fehlern als alt behandeln
        }
    }
    
    function updateDiceResultSection(gameStatus) {
        console.log(`updateDiceResultSection called - Phase: ${gameStatus.current_status}, Has dice_result: ${!!gameStatus.dice_result}`);
        
        // VEREINFACHTE LOGIK: Vertraue dem Server is_recent Flag
        if (gameStatus.current_status === 'W√ºrfelrunde' && gameStatus.dice_result && gameStatus.dice_result.is_recent) {
            const diceResult = gameStatus.dice_result;
            console.log('Processing dice result (is_recent=true):', diceResult);
            
            const teamKey = diceResult.team_name;
            const diceKey = `${diceResult.team_name}-${diceResult.timestamp}-${diceResult.total_roll}`;
            
            // F√ºge zur Sammlung hinzu, nur wenn es ein neues Team ist
            if (!processedTeams.has(teamKey)) {
                console.log(`NEW team ${teamKey} - adding to collection`);
                processedTeams.add(teamKey);
                addDiceResult(diceResult);
                resetDiceRoundHideTimer();
                
                // Zeige auch das Live-Popup
                if (lastDiceResult !== diceKey) {
                    lastDiceResult = diceKey;
                    showDiceResult(diceResult, gameStatus);
                }
            } else {
                console.log(`Team ${teamKey} already processed`);
            }
        } else {
            console.log(`No dice result or not recent (is_recent: ${gameStatus.dice_result?.is_recent})`);
            // Kein W√ºrfelergebnis oder nicht in W√ºrfelrunde
            if (gameStatus.current_status !== 'W√ºrfelrunde') {
                hideDiceResult();
            }
        }
    }
    
    function showDiceResult(diceResult, gameStatus) {
        console.log('Showing dice result:', diceResult);
        
        // Pr√ºfe ob alle Elemente existieren
        const diceDisplay = document.getElementById('dice-result-display');
        const teamNameEl = document.getElementById('dice-team-name');
        const standardEl = document.getElementById('dice-standard');
        const totalEl = document.getElementById('dice-total');
        const timestampEl = document.getElementById('dice-timestamp');
        const bonusSection = document.getElementById('dice-bonus-section');
        const bonusEl = document.getElementById('dice-bonus');
        
        console.log('Element check:', {
            diceDisplay: !!diceDisplay,
            teamNameEl: !!teamNameEl,
            standardEl: !!standardEl,
            totalEl: !!totalEl,
            timestampEl: !!timestampEl,
            bonusSection: !!bonusSection,
            bonusEl: !!bonusEl
        });
        
        if (!diceDisplay) {
            console.error('dice-result-display element not found!');
            return;
        }
        
        // Aktualisiere Werte
        if (teamNameEl) teamNameEl.textContent = diceResult.team_name;
        if (standardEl) standardEl.textContent = diceResult.standard_roll;
        if (totalEl) totalEl.textContent = diceResult.total_roll;
        if (timestampEl) timestampEl.textContent = `Zeit: ${diceResult.timestamp}`;
        
        // Bonus-Sektion nur anzeigen wenn Bonus-W√ºrfel vorhanden
        if (bonusSection && bonusEl) {
            if (diceResult.has_bonus && diceResult.bonus_roll > 0) {
                bonusEl.textContent = diceResult.bonus_roll;
                bonusSection.style.display = 'block';
            } else {
                bonusSection.style.display = 'none';
            }
        }
        
        // Zeige das W√ºrfelergebnis-Feld - SOFORT UND VOLLST√ÑNDIG SICHTBAR
        diceDisplay.style.display = 'block';
        diceDisplay.style.visibility = 'visible';
        diceDisplay.style.opacity = '1';
        // Entferne problematische Position- und z-index-Styles f√ºr mobile Ger√§te
        diceDisplay.style.position = '';
        diceDisplay.style.zIndex = '';
        diceDisplay.style.width = 'auto';
        diceDisplay.style.height = 'auto';
        
        // Entferne alle Klassen, die das Element verstecken k√∂nnten
        diceDisplay.classList.remove('fade-out');
        
        console.log('Dice display element shown, style.display:', diceDisplay.style.display);
        
        // Warte kurz und pr√ºfe dann nochmal die Gr√∂√üe
        setTimeout(() => {
            console.log('Element position and size after timeout:', {
                offsetTop: diceDisplay.offsetTop,
                offsetLeft: diceDisplay.offsetLeft,
                offsetWidth: diceDisplay.offsetWidth,
                offsetHeight: diceDisplay.offsetHeight,
                computed: window.getComputedStyle(diceDisplay).display,
                visibility: window.getComputedStyle(diceDisplay).visibility,
                opacity: window.getComputedStyle(diceDisplay).opacity
            });
        }, 100);
        
        // L√∂sche vorherigen Timeout
        if (diceResultTimeout) {
            clearTimeout(diceResultTimeout);
        }
        
        // Auto-Ausblenden nach 5 Sekunden (normale W√ºrfelrunde)
        // Verl√§ngerte Anzeige wird durch Phasenwechsel-Handler √ºbernommen
        diceResultTimeout = setTimeout(() => {
            console.log('Auto-hiding dice result after 5 seconds (normal dice roll)');
            hideDiceResult();
        }, 5000);
    }
    
    function hideDiceResult() {
        const diceDisplay = document.getElementById('dice-result-display');
        if (diceDisplay && diceDisplay.style.display !== 'none') {
            // Smooth fade-out animation
            diceDisplay.classList.add('fade-out');
            
            setTimeout(() => {
                diceDisplay.style.display = 'none';
                diceDisplay.classList.remove('fade-out');
            }, 500);
        }
        
        if (diceResultTimeout) {
            clearTimeout(diceResultTimeout);
            diceResultTimeout = null;
        }
        
        lastDiceResult = null;
    }
    function generateResultsHTML(results) {
        if (!results || !results.placements || results.placements.length === 0) return '';
        let html = '<strong>üèÜ Platzierungen:</strong><div class="row mt-2">';
        results.placements.forEach(result => {
            let medal = result.placement === 1 ? 'ü•á' : result.placement === 2 ? 'ü•à' : result.placement === 3 ? 'ü•â' : `${result.placement}.`;
            let borderClass = result.placement === 1 ? 'warning' : result.placement === 2 ? 'secondary' : result.placement === 3 ? 'info' : 'light';
            html += `<div class="col-md-4 mb-2">
                <div class="card border-${borderClass}">
                    <div class="card-body p-2 text-center">
                        <div class="h4 mb-1">${medal}</div>
                        <strong>${result.team_name}</strong>
                    </div>
                </div>
            </div>`;
        });
        html += '</div>';
        return html;
    }
    
    // W√úRFELRUNDEN-ERGEBNISSE MANAGEMENT
    function resetDiceRoundHideTimer() {
        // L√∂sche vorherigen Timer
        if (diceRoundHideTimeout) {
            clearTimeout(diceRoundHideTimeout);
        }
        
        // Setze neuen Timer f√ºr 10 Sekunden
        diceRoundHideTimeout = setTimeout(() => {
            console.log('Auto-hiding dice round results after 10 seconds');
            const diceRoundDiv = document.getElementById('dice-round-results');
            if (diceRoundDiv) {
                diceRoundDiv.style.display = 'none';
            }
            clearDiceRoundResults();
        }, 10000);
        
        console.log('Reset dice round hide timer to 10 seconds');
    }
    
    function addDiceResult(diceResult) {
        // Pr√ºfe ob es ein neues, g√ºltiges W√ºrfelergebnis ist
        if (!diceResult || !diceResult.team_name || !diceResult.total_roll) {
            console.log('Invalid dice result, not adding:', diceResult);
            return;
        }
        
        const resultKey = `${diceResult.team_name}-${diceResult.total_roll}-${diceResult.standard_roll}-${diceResult.bonus_roll || 0}`;
        const exists = diceRoundResults.some(r => `${r.team_name}-${r.total_roll}-${r.standard_roll}-${r.bonus_roll}` === resultKey);
        
        if (!exists) {
            diceRoundResults.push({
                team_name: diceResult.team_name,
                standard_roll: diceResult.standard_roll,
                bonus_roll: diceResult.bonus_roll || 0,
                total_roll: diceResult.total_roll,
                has_bonus: diceResult.has_bonus,
                timestamp: diceResult.timestamp
            });
            
            console.log(`Added dice result for ${diceResult.team_name}: ${diceResult.total_roll}. Total results: ${diceRoundResults.length}`);
            updateDiceRoundDisplay();
        } else {
            console.log(`Dice result already exists for ${diceResult.team_name} at ${diceResult.timestamp}`);
        }
    }
    
    function clearDiceRoundResults() {
        diceRoundResults = [];
        processedTeams.clear();
        updateDiceRoundDisplay();
        console.log('Cleared dice round results and processed teams');
        
        // L√∂sche Auto-Hide Timer
        if (diceRoundHideTimeout) {
            clearTimeout(diceRoundHideTimeout);
            diceRoundHideTimeout = null;
        }
    }
    
    function updateDiceRoundDisplay() {
        const diceRoundDiv = document.getElementById('dice-round-results');
        const container = document.getElementById('dice-results-container');
        const summaryDiv = document.getElementById('dice-round-summary');
        
        if (!container) return;
        
        if (diceRoundResults.length === 0) {
            diceRoundDiv.style.display = 'none';
            return;
        }
        
        console.log(`Updating dice round display with ${diceRoundResults.length} results`);
        console.log('Results:', diceRoundResults);
        
        // Zeige das W√ºrfelrunden-Feld
        diceRoundDiv.style.display = 'block';
        
        // Erstelle HTML f√ºr alle Ergebnisse
        let html = '';
        diceRoundResults.forEach(result => {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card border-info">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-users"></i> ${result.team_name}
                            </h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Standard</small>
                                    <div class="h5 text-primary">${result.standard_roll}</div>
                                </div>
                                ${result.has_bonus ? `
                                <div class="col-4">
                                    <small class="text-muted">Bonus</small>
                                    <div class="h5 text-warning">${result.bonus_roll}</div>
                                </div>
                                ` : '<div class="col-4"></div>'}
                                <div class="col-4">
                                    <small class="text-muted">Gesamt</small>
                                    <div class="h4 text-success font-weight-bold">${result.total_roll}</div>
                                </div>
                            </div>
                            <small class="text-muted">${result.timestamp}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Update Statistiken
        if (diceRoundResults.length > 0) {
            const totals = diceRoundResults.map(r => r.total_roll);
            const highest = Math.max(...totals);
            const average = (totals.reduce((a, b) => a + b, 0) / totals.length).toFixed(1);
            
            document.getElementById('highest-roll').textContent = highest;
            document.getElementById('average-roll').textContent = average;
            summaryDiv.style.display = 'block';
        }
    }
    
    function updateSequenceSection(sequenceInfo) {
        const sequenceDisplay = document.getElementById('sequence-info-display');
        
        // FIXE: Sequenz-Anzeige IMMER sichtbar machen - egal ob sequenceInfo vorhanden ist
        if (sequenceDisplay) {
            sequenceDisplay.style.display = 'block';
            sequenceDisplay.style.visibility = 'visible';
            console.log('Sequence display forced to be visible');
        }
        
        if (sequenceInfo) {
            console.log('Updating sequence info:', sequenceInfo);
            
            // Update Fortschrittsbalken
            const progressBar = document.getElementById('sequence-progress-bar');
            if (progressBar) {
                progressBar.style.width = sequenceInfo.progress_percentage + '%';
                progressBar.textContent = sequenceInfo.progress_percentage + '%';
            }
            
            // Update Position Text
            const positionText = document.getElementById('sequence-position-text');
            if (positionText) {
                positionText.textContent = `${sequenceInfo.current_position + 1} von ${sequenceInfo.total_items} abgeschlossen`;
            }
            
            // Dynamisch Sequenz-Karte erstellen falls nicht vorhanden
            const sequenceCard = document.getElementById('sequence-info-card');
            if (sequenceCard && sequenceCard.innerHTML.trim() === '') {
                updateSequenceCard(sequenceCard, sequenceInfo);
            }
        } else {
            console.log('No sequence info received, but keeping display visible');
        }
        // Sequenz-Anzeige wird NIEMALS versteckt - bleibt permanent sichtbar
    }
    
    function updateSequenceCard(cardElement, sequenceInfo) {
        let html = `
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list-ol"></i> 
                    Aktiver Ablaufplan: ${sequenceInfo.name}
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h6>Fortschritt</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-info" id="sequence-progress-bar"
                                 style="width: ${sequenceInfo.progress_percentage}%">
                                ${sequenceInfo.progress_percentage}%
                            </div>
                        </div>
                        <small class="text-muted" id="sequence-position-text">
                            ${sequenceInfo.current_position + 1} von ${sequenceInfo.total_items} abgeschlossen
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="text-right">`;
        
        if (sequenceInfo.current_item) {
            const currentIcon = sequenceInfo.current_item.type === 'minigame' ? 'fas fa-gamepad text-primary' : 'fas fa-question-circle text-info';
            html += `
                            <h6 class="text-warning">
                                <i class="fas fa-play"></i> Aktuell:
                            </h6>
                            <div class="card border-warning">
                                <div class="card-body p-2">
                                    <i class="${currentIcon}"></i>
                                    <strong>${sequenceInfo.current_item.name}</strong>
                                </div>
                            </div>`;
        }
        
        if (sequenceInfo.next_item) {
            const nextIcon = sequenceInfo.next_item.type === 'minigame' ? 'fas fa-gamepad text-primary' : 'fas fa-question-circle text-info';
            html += `
                            <h6 class="text-muted mt-3">
                                <i class="fas fa-step-forward"></i> Als n√§chstes:
                            </h6>
                            <div class="card border-light">
                                <div class="card-body p-2">
                                    <i class="${nextIcon}"></i>
                                    <strong>${sequenceInfo.next_item.name}</strong>
                                </div>
                            </div>`;
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>`;
        
        cardElement.innerHTML = html;
    }
    
    // Stelle sicher, dass Sequenz-Anzeige beim Laden sichtbar ist
    const sequenceDisplay = document.getElementById('sequence-info-display');
    if (sequenceDisplay) {
        sequenceDisplay.style.display = 'block';
        sequenceDisplay.style.visibility = 'visible';
        console.log('Initial sequence display made visible');
    }
    
    // Starte Updates alle 3 Sekunden
    setInterval(updateStatus, 3000);
    
    // Initialer Update nach 1 Sekunde
    setTimeout(updateStatus, 1000);
});
</script>
        </div>
    </div>
</div>
{% endblock %}