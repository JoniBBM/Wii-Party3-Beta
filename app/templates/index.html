{% extends "base.html" %}

{% block title %}Willkommen bei Wii Party U Deluxe{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Page-specific background */
    html, body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    /* Modern Hero Section */
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
        min-height: 100vh;
        display: flex;
        align-items: center;
        color: white;
    }

    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%),
                    linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.1) 75%),
                    linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.1) 75%);
        background-size: 60px 60px;
        background-position: 0 0, 0 30px, 30px -30px, -30px 0px;
        animation: movePattern 20s linear infinite;
        opacity: 0.3;
    }

    @keyframes movePattern {
        0% { transform: translateX(0px) translateY(0px); }
        100% { transform: translateX(60px) translateY(60px); }
    }

    .hero-content {
        position: relative;
        z-index: 2;
        text-align: center;
        padding: 2rem 0;
    }

    .hero-title {
        font-size: 4rem;
        font-weight: 900;
        margin-bottom: 1rem;
        text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        background: linear-gradient(45deg, #fff, #f8f9ff, #fff);
        background-size: 200% 200%;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 3s ease-in-out infinite;
        line-height: 1.1;
    }

    @keyframes shimmer {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .hero-subtitle {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        opacity: 0.95;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    .hero-buttons {
        margin-top: 2rem;
    }

    .btn-hero {
        padding: 1rem 2.5rem;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 50px;
        margin: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-block;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn-hero:hover::before {
        left: 100%;
    }

    .btn-hero-primary {
        background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        color: white;
        border: none;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
    }

    .btn-hero-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
        color: white;
    }

    .btn-hero-secondary {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: white;
        border: none;
        box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
    }

    .btn-hero-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(78, 205, 196, 0.4);
        color: white;
    }

    .btn-hero-outline {
        background: transparent;
        color: white;
        border: 2px solid rgba(255,255,255,0.8);
        box-shadow: 0 8px 25px rgba(255, 255, 255, 0.1);
    }

    .btn-hero-outline:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* Floating Elements */
    .floating-elements {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 1;
    }

    .floating-element {
        position: absolute;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        animation: float 15s infinite linear;
    }

    .floating-element:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
    }

    .floating-element:nth-child(2) {
        width: 120px;
        height: 120px;
        top: 60%;
        right: 15%;
        animation-delay: -5s;
    }

    .floating-element:nth-child(3) {
        width: 60px;
        height: 60px;
        top: 80%;
        left: 80%;
        animation-delay: -10s;
    }

    @keyframes float {
        0% {
            transform: translateY(0px) rotate(0deg);
            opacity: 0.7;
        }
        33% {
            transform: translateY(-30px) rotate(120deg);
            opacity: 0.9;
        }
        66% {
            transform: translateY(-60px) rotate(240deg);
            opacity: 0.7;
        }
        100% {
            transform: translateY(0px) rotate(360deg);
            opacity: 0.7;
        }
    }

    /* Features Section */
    .features-section {
        padding: 5rem 0;
        background: linear-gradient(180deg, #f8f9ff 0%, #ffffff 100%);
    }

    .section-title {
        text-align: center;
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .section-subtitle {
        text-align: center;
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 4rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .feature-card {
        background: white;
        border-radius: 20px;
        padding: 2.5rem 2rem;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255,255,255,0.8);
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .feature-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(45deg, #667eea, #764ba2);
    }

    .feature-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    .feature-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        position: relative;
    }

    .feature-icon::after {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 50%;
        z-index: -1;
        opacity: 0.3;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            opacity: 0.3;
        }
        70% {
            transform: scale(1);
            opacity: 0.1;
        }
        100% {
            transform: scale(0.95);
            opacity: 0.3;
        }
    }

    .feature-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
    }

    .feature-description {
        color: #666;
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .feature-list {
        text-align: left;
        list-style: none;
        padding: 0;
    }

    .feature-list li {
        padding: 0.5rem 0;
        position: relative;
        padding-left: 2rem;
        color: #555;
    }

    .feature-list li::before {
        content: 'üéÆ';
        position: absolute;
        left: 0;
        top: 0.5rem;
    }

    /* Game Overview Section */
    .game-overview {
        padding: 5rem 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .game-overview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="80" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .game-overview-content {
        position: relative;
        z-index: 2;
        text-align: center;
    }

    .game-overview h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
    }

    .game-overview p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
        opacity: 0.9;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.5rem;
        }
        
        .hero-subtitle {
            font-size: 1.2rem;
        }
        
        .btn-hero {
            padding: 0.8rem 2rem;
            font-size: 1rem;
            margin: 0.3rem;
        }
        
        .section-title {
            font-size: 2rem;
        }
        
        .feature-card {
            margin-bottom: 2rem;
        }
        
        .hero-section {
            min-height: 80vh;
        }
    }

    /* Custom Animations */
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.8s ease-out forwards;
    }

    .fade-in-up:nth-child(1) { animation-delay: 0.1s; }
    .fade-in-up:nth-child(2) { animation-delay: 0.2s; }
    .fade-in-up:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Registration Pop-up Styles */
    .registration-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .registration-popup.show {
        display: flex;
    }

    .registration-modal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        position: relative;
        color: white;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        animation: popupSlideIn 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
    }

    @keyframes popupSlideIn {
        from {
            opacity: 0;
            transform: scale(0.8) translateY(-50px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .registration-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .registration-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .registration-subtitle {
        opacity: 0.9;
        font-size: 1rem;
    }

    .registration-form {
        margin-bottom: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .form-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        backdrop-filter: blur(10px);
    }

    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .form-input:focus {
        outline: none;
        border-color: #FFD700;
        background: rgba(255, 255, 255, 0.2);
    }

    .registration-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .btn-popup {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .btn-popup-primary {
        background: #FFD700;
        color: #333;
    }

    .btn-popup-primary:hover {
        background: #FFC107;
        transform: translateY(-2px);
    }

    .btn-popup-secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-popup-secondary:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .registration-status {
        text-align: center;
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 10px;
        display: none;
    }

    .status-success {
        background: rgba(76, 175, 80, 0.3);
        border: 1px solid rgba(76, 175, 80, 0.5);
    }

    .status-error {
        background: rgba(244, 67, 54, 0.3);
        border: 1px solid rgba(244, 67, 54, 0.5);
    }

    .popup-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .popup-close:hover {
        opacity: 1;
    }

    .registration-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        z-index: 9999;
        display: none;
        align-items: center;
        gap: 0.5rem;
        animation: slideInRight 0.5s ease-out;
        cursor: pointer;
    }

    .registration-indicator.show {
        display: flex;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .indicator-pulse {
        width: 12px;
        height: 12px;
        background: #FFD700;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @media (max-width: 480px) {
        .registration-modal {
            padding: 1.5rem;
            margin: 1rem;
        }
        
        .registration-buttons {
            flex-direction: column;
        }
    }

    /* PROFILBILD CAMERA STYLES f√ºr Registration Modal */
    .camera-step {
        display: none;
        text-align: center;
        margin-top: 1rem;
    }

    .camera-step.show {
        display: block;
    }

    .camera-preview {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 1rem auto;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.5);
        background: rgba(0, 0, 0, 0.2);
    }

    .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .camera-canvas {
        display: none;
    }

    .camera-captured {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .camera-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
        margin: 1rem 0;
    }

    .btn-camera {
        padding: 0.6rem 1rem;
        border-radius: 20px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .btn-camera-capture {
        background: linear-gradient(45deg, #FF6B6B, #EE5A52);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    .btn-camera-capture:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 107, 0.5);
    }

    .btn-camera-retake {
        background: linear-gradient(45deg, #FFA726, #FF9800);
        color: white;
        box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
    }

    .btn-camera-retake:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 167, 38, 0.5);
    }

    .btn-camera-save {
        background: linear-gradient(45deg, #4CAF50, #45A049);
        color: white;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .btn-camera-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
    }

    .btn-camera-skip {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-camera-skip:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .camera-status {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        opacity: 0.9;
        min-height: 20px;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
    }

    .step-dot.active {
        background: #FFD700;
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>
    
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Wii Party U<br>Deluxe</h1>
            <p class="hero-subtitle">Das ultimative Partyspiel-Erlebnis f√ºr Browser.<br>Spiele, lache und gewinne mit deinen Freunden!</p>
            
            <div class="hero-buttons">
                {% if current_user.is_authenticated and user_type_in_context == 'admin' %}
                <a href="{{ url_for('main.game_board') }}" class="btn btn-hero btn-hero-primary">
                    <i class="fas fa-gamepad mr-2"></i>Zum Spielbrett
                </a>
                {% endif %}
                
                {% if current_user.is_authenticated and user_type_in_context == 'admin' %}
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-hero btn-hero-secondary">
                        <i class="fas fa-cog mr-2"></i>Admin Dashboard
                    </a>
                {% elif current_user.is_authenticated and user_type_in_context == 'team' %}
                    <a href="{{ url_for('teams.team_dashboard') }}" class="btn btn-hero btn-hero-secondary">
                        <i class="fas fa-users mr-2"></i>Mein Team
                    </a>
                {% else %}
                    <a href="{{ url_for('teams.team_login') }}" class="btn btn-hero btn-hero-secondary">
                        <i class="fas fa-sign-in-alt mr-2"></i>Team Login
                    </a>
                    <a href="{{ url_for('admin.login') }}" class="btn btn-hero btn-hero-outline">
                        <i class="fas fa-user-shield mr-2"></i>Admin Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section">
    <div class="container">
        <h2 class="section-title">Warum Wii Party U Deluxe?</h2>
        <p class="section-subtitle">Erlebe packende Minispiele, spannende Wettk√§mpfe und endlosen Spa√ü mit deinen Freunden in einer komplett neuen Dimension!</p>
        
        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card fade-in-up">
                    <div class="feature-icon">
                        <i class="fas fa-dice"></i>
                    </div>
                    <h3 class="feature-title">Spielregeln</h3>
                    <p class="feature-description">Einfach zu lernen, schwer zu meistern! Sammle Sterne durch geschickte Z√ºge und Minispiel-Erfolge.</p>
                    <ul class="feature-list">
                        <li>W√ºrfle und bewege dich √ºber das Brett</li>
                        <li>Spiele spannende Minispiele</li>
                        <li>Bonusw√ºrfel f√ºr Gewinner (1-6, 1-4, 1-2)</li>
                        <li>Erreiche als Erster das Ziel!</li>
                    </ul>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="feature-card fade-in-up">
                    <div class="feature-icon">
                        <i class="fas fa-magic"></i>
                    </div>
                    <h3 class="feature-title">Premium Features</h3>
                    <p class="feature-description">Modernste Technologie trifft auf klassischen Spielspa√ü f√ºr ein unvergessliches Erlebnis.</p>
                    <ul class="feature-list">
                        <li>Interaktives 3D-Spielbrett</li>
                        <li>Einzigartige Charaktere</li>
                        <li>Vielf√§ltige Minispiele</li>
                        <li>Team-basiertes Gameplay</li>
                        <li>Admin-Dashboard f√ºr Kontrolle</li>
                    </ul>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-12 mb-4">
                <div class="feature-card fade-in-up">
                    <div class="feature-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="feature-title">Multiplayer Spa√ü</h3>
                    <p class="feature-description">Spiele mit deinen Freunden, familie oder Kollegen und erlebe unvergessliche Momente!</p>
                    <ul class="feature-list">
                        <li>Bis zu 6 Teams gleichzeitig</li>
                        <li>Lokaler und Online-Multiplayer</li>
                        <li>Teamstatistiken & Ranglisten</li>
                        <li>Individuelle Team-Dashboards</li>
                        <li>Spielstand-Speicherung</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Game Overview Section -->
<section class="game-overview">
    <div class="container">
        <div class="game-overview-content">
            <h3>Bereit f√ºr das Abenteuer?</h3>
            <p>Starte jetzt dein erstes Spiel und entdecke die Welt von Wii Party U Deluxe. Ob Anf√§nger oder Profi - hier findet jeder seinen Spa√ü!</p>
            
            {% if current_user.is_authenticated and user_type_in_context == 'team' %}
                <a href="{{ url_for('teams.team_dashboard') }}" class="btn btn-hero btn-hero-primary">
                    <i class="fas fa-rocket mr-2"></i>Zu meinem Team-Dashboard
                </a>
            {% else %}
                <a href="{{ url_for('teams.team_dashboard') }}" class="btn btn-hero btn-hero-primary">
                    <i class="fas fa-rocket mr-2"></i>Team-Bereich erkunden
                </a>
            {% endif %}
            
            {% if current_user.is_authenticated and user_type_in_context == 'admin' %}
            <a href="{{ url_for('main.game_board') }}" class="btn btn-hero btn-hero-outline">
                <i class="fas fa-eye mr-2"></i>Spielbrett ansehen
            </a>
            {% endif %}
        </div>
    </div>
</section>

<!-- Registrierungs-Indikator -->
<div id="registration-indicator" class="registration-indicator">
    <div class="indicator-pulse"></div>
    Jetzt anmelden!
</div>

<!-- Registrierungs-Pop-up -->
<div id="registration-popup" class="registration-popup">
    <div class="registration-modal">
        <button class="popup-close" onclick="closeRegistrationPopup()">&times;</button>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step-dot active" id="step-dot-1"></div>
            <div class="step-dot" id="step-dot-2"></div>
        </div>
        
        <!-- Step 1: Name eingeben -->
        <div id="step-1" class="registration-step">
            <div class="registration-header">
                <h3 class="registration-title">üéÆ Jetzt anmelden!</h3>
                <p class="registration-subtitle">Trage deinen Namen ein und sei beim Spiel dabei!</p>
            </div>

            <form id="registration-form" class="registration-form">
                <div class="form-group">
                    <label for="player-name" class="form-label">Dein Name:</label>
                    <input type="text" id="player-name" class="form-input" placeholder="Gib deinen Namen ein..." maxlength="50" required>
                </div>
                
                <div class="registration-buttons">
                    <button type="button" class="btn-popup btn-popup-primary" onclick="proceedToCamera()">
                        <i class="fas fa-camera"></i> Weiter zum Foto
                    </button>
                    <button type="button" class="btn-popup btn-popup-secondary" onclick="closeRegistrationPopup()">
                        Abbrechen
                    </button>
                </div>
            </form>
        </div>

        <!-- Step 2: Camera -->
        <div id="step-2" class="registration-step camera-step">
            <div class="registration-header">
                <h3 class="registration-title">üì∏ Profilbild aufnehmen</h3>
                <p class="registration-subtitle">Nimm ein Selfie f√ºr dein Profil auf!</p>
            </div>

            <div class="camera-preview">
                <video id="camera-video" class="camera-video" autoplay muted></video>
                <canvas id="camera-canvas" class="camera-canvas"></canvas>
                <img id="camera-captured" class="camera-captured" style="display: none;">
            </div>
            
            <div class="camera-controls">
                <button id="btn-start-camera" class="btn-camera btn-camera-capture">
                    <i class="fas fa-video"></i> Kamera starten
                </button>
                <button id="btn-upload-file" class="btn-camera btn-camera-retake" style="display: none;">
                    <i class="fas fa-upload"></i> Foto hochladen
                </button>
                <button id="btn-check-permissions" class="btn-camera btn-camera-retake" style="display: none;">
                    <i class="fas fa-shield-alt"></i> Berechtigungen pr√ºfen
                </button>
                <button id="btn-take-photo" class="btn-camera btn-camera-capture" style="display: none;">
                    <i class="fas fa-camera"></i> Foto aufnehmen
                </button>
                <button id="btn-retake-photo" class="btn-camera btn-camera-retake" style="display: none;">
                    <i class="fas fa-redo"></i> Nochmal
                </button>
                <button id="btn-save-and-register" class="btn-camera btn-camera-save" style="display: none;">
                    <i class="fas fa-save"></i> Speichern & Anmelden
                </button>
                <button id="btn-skip-photo" class="btn-camera btn-camera-skip">
                    <i class="fas fa-forward"></i> Ohne Foto anmelden
                </button>
            </div>
            
            <!-- Hidden File Input f√ºr HTTP-Fallback -->
            <input type="file" id="file-input" accept="image/*" capture="user" style="display: none;">
            
            <div class="camera-status" id="camera-status">
                Klicke auf "Kamera starten" um ein Selfie aufzunehmen.
            </div>
            
            <div class="registration-buttons">
                <button type="button" class="btn-popup btn-popup-secondary" onclick="backToNameStep()">
                    <i class="fas fa-arrow-left"></i> Zur√ºck
                </button>
            </div>
        </div>

        <div id="registration-status" class="registration-status">
            <span id="status-message"></span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Intersection Observer f√ºr Animations-Trigger
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationPlayState = 'running';
            }
        });
    }, observerOptions);

    // Beobachte alle Elemente mit fade-in-up Klasse
    document.querySelectorAll('.fade-in-up').forEach(el => {
        observer.observe(el);
    });

    // Smooth Scrolling f√ºr interne Links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Parallax-Effekt f√ºr Hero-Section
    const heroSection = document.querySelector('.hero-section');
    if (heroSection) {
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5;
            heroSection.style.transform = `translateY(${rate}px)`;
        });
    }

    // Registrierungs-Funktionalit√§t
    checkRegistrationStatus();
    setInterval(checkRegistrationStatus, 5000); // Alle 5 Sekunden pr√ºfen

    // Registrierungs-Pop-up Event Listeners
    document.getElementById('registration-indicator').addEventListener('click', showRegistrationPopup);
    document.getElementById('registration-form').addEventListener('submit', handleRegistrationFormSubmit);
    
    // Enter-Key im Namen-Input
    document.getElementById('player-name').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const playerName = this.value.trim();
            if (playerName) {
                proceedToCamera();
            } else {
                showRegistrationStatus('Bitte gib einen Namen ein!', 'error');
            }
        }
    });
    
    // ESC-Taste zum Schlie√üen
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('registration-popup').classList.contains('show')) {
            closeRegistrationPopup();
        }
    });
});

function checkRegistrationStatus() {
    fetch('/api/registration-status')
        .then(response => response.json())
        .then(data => {
            console.log('Registration status:', data);  // Debug
            const indicator = document.getElementById('registration-indicator');
            if (data.success && data.registration_active && !data.teams_created) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
                // Schlie√üe Pop-up falls offen
                document.getElementById('registration-popup').classList.remove('show');
            }
        })
        .catch(error => {
            console.error('Error checking registration status:', error);
        });
}

function showRegistrationPopup() {
    document.getElementById('registration-popup').classList.add('show');
    document.getElementById('player-name').focus();
}

function closeRegistrationPopup() {
    document.getElementById('registration-popup').classList.remove('show');
    document.getElementById('registration-form').reset();
    document.getElementById('registration-status').style.display = 'none';
}

function handleRegistrationFormSubmit(event) {
    event.preventDefault();
    
    // Bei Enter oder Form-Submit: gehe zum Foto-Schritt
    const playerName = document.getElementById('player-name').value.trim();
    if (playerName) {
        proceedToCamera();
    } else {
        showRegistrationStatus('Bitte gib einen Namen ein!', 'error');
    }
}

function handleRegistration(event) {
    event.preventDefault();
    
    const playerName = document.getElementById('player-name').value.trim();
    if (!playerName) {
        showRegistrationStatus('Bitte gib einen Namen ein!', 'error');
        return;
    }

    // CSRF Token holen
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // Button deaktivieren w√§hrend Request - sicher pr√ºfen
    const submitBtn = event.target.querySelector('button[type="submit"]');
    let originalText = '';
    if (submitBtn) {
        originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird angemeldet...';
    }

    fetch('/api/register-player', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ player_name: playerName })
    })
    .then(async response => {
        if (!response.ok) {
            // Bei 400 Bad Request, versuche JSON Response zu lesen f√ºr Fehlerdetails
            if (response.status === 400) {
                try {
                    const text = await response.text();
                    console.error('400 Bad Request response:', text);
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    } catch (parseError) {
                        console.error('Could not parse error response as JSON:', parseError);
                        throw new Error(`HTTP error! status: ${response.status} - ${text}`);
                    }
                } catch (readError) {
                    console.error('Could not read error response:', readError);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Expected JSON, got:', text);
            throw new Error('Server returned non-JSON response');
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showRegistrationStatus('Erfolgreich angemeldet! üéâ', 'success');
            setTimeout(() => {
                closeRegistrationPopup();
            }, 2000);
        } else {
            showRegistrationStatus(data.error || 'Fehler bei der Anmeldung', 'error');
        }
    })
    .catch(error => {
        console.error('Registration error:', error);
        let errorMessage = 'Ein Fehler ist aufgetreten. Versuche es nochmal!';
        if (error.message.includes('Server returned non-JSON response')) {
            errorMessage = 'Server-Fehler: Ung√ºltige Antwort erhalten';
        } else if (error.message.includes('HTTP error!')) {
            errorMessage = 'Netzwerk-Fehler: Verbindung zum Server fehlgeschlagen';
        }
        showRegistrationStatus(errorMessage, 'error');
    })
    .finally(() => {
        // Button wieder aktivieren - sicher pr√ºfen
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
}

function showRegistrationStatus(message, type) {
    const statusDiv = document.getElementById('registration-status');
    const messageSpan = document.getElementById('status-message');
    
    statusDiv.className = `registration-status status-${type}`;
    messageSpan.textContent = message;
    statusDiv.style.display = 'block';
}

// PROFILBILD CAMERA SYSTEM f√ºr Registration Modal

let cameraStream = null;
let capturedImageData = null;

// Event Listeners f√ºr Camera
document.addEventListener('DOMContentLoaded', function() {
    const btnStartCamera = document.getElementById('btn-start-camera');
    const btnUploadFile = document.getElementById('btn-upload-file');
    const btnCheckPermissions = document.getElementById('btn-check-permissions');
    const btnTakePhoto = document.getElementById('btn-take-photo');
    const btnRetakePhoto = document.getElementById('btn-retake-photo');
    const btnSaveAndRegister = document.getElementById('btn-save-and-register');
    const btnSkipPhoto = document.getElementById('btn-skip-photo');
    const fileInput = document.getElementById('file-input');

    if (btnStartCamera) btnStartCamera.addEventListener('click', startCamera);
    if (btnUploadFile) btnUploadFile.addEventListener('click', triggerFileUpload);
    if (btnCheckPermissions) btnCheckPermissions.addEventListener('click', checkAndRequestPermissions);
    if (btnTakePhoto) btnTakePhoto.addEventListener('click', takePhoto);
    if (btnRetakePhoto) btnRetakePhoto.addEventListener('click', retakePhoto);
    if (btnSaveAndRegister) btnSaveAndRegister.addEventListener('click', savePhotoAndRegister);
    if (btnSkipPhoto) btnSkipPhoto.addEventListener('click', skipPhotoAndRegister);
    if (fileInput) fileInput.addEventListener('change', handleFileUpload);
});

async function proceedToCamera() {
    const playerName = document.getElementById('player-name').value.trim();
    if (!playerName) {
        showRegistrationStatus('Bitte gib einen Namen ein!', 'error');
        return;
    }
    
    // Pr√ºfe Kamera-Verf√ºgbarkeit vor dem Wechsel
    const cameraAvailable = await checkCameraAvailability();
    
    // Switch to camera step
    document.getElementById('step-1').style.display = 'none';
    document.getElementById('step-2').classList.add('show');
    
    // Update step indicator
    document.getElementById('step-dot-1').classList.remove('active');
    document.getElementById('step-dot-2').classList.add('active');
    
    // Clear any previous status
    document.getElementById('registration-status').style.display = 'none';
    
    resetCameraUI();
    
    // Zeige Hinweis wenn Kamera nicht verf√ºgbar oder HTTP
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    
    if (!cameraAvailable || !isSecure) {
        let statusMessage = '';
        
        if (!isSecure) {
            statusMessage = `
                <div style="color: #ffa726; margin-bottom: 1rem;">
                    ‚ö†Ô∏è HTTP-Verbindung erkannt - Kamera m√∂glicherweise eingeschr√§nkt
                </div>
                <div style="font-size: 0.8rem; opacity: 0.8;">
                    Auf manchen Ger√§ten/Browsern funktioniert die Kamera nur √ºber HTTPS.
                    <br>Du kannst aber trotzdem versuchen oder ein Foto hochladen!
                </div>
            `;
            
            // Zeige Upload-Button f√ºr HTTP
            const uploadButton = document.getElementById('btn-upload-file');
            if (uploadButton) {
                uploadButton.style.display = 'inline-block';
            }
        } else {
            statusMessage = `
                <div style="color: #ffa726; margin-bottom: 1rem;">
                    ‚ö†Ô∏è Kamera m√∂glicherweise nicht verf√ºgbar auf diesem Ger√§t.
                </div>
                <div style="font-size: 0.8rem; opacity: 0.8;">
                    Du kannst trotzdem "Kamera starten" versuchen, ein Foto hochladen oder "Ohne Foto fortfahren" w√§hlen.
                </div>
            `;
            
            // Zeige Upload-Button als Alternative
            const uploadButton = document.getElementById('btn-upload-file');
            if (uploadButton) {
                uploadButton.style.display = 'inline-block';
            }
        }
        
        document.getElementById('camera-status').innerHTML = statusMessage;
        
        // Mache "Ohne Foto" Button prominenter
        const skipButton = document.getElementById('btn-skip-photo');
        if (skipButton) {
            skipButton.style.background = 'linear-gradient(45deg, #4CAF50, #45A049)';
            skipButton.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto fortfahren';
        }
    }
}

async function checkCameraAvailability() {
    try {
        // Pr√ºfe ob getUserMedia verf√ºgbar ist
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return false;
        }
        
        // Pr√ºfe ob HTTPS oder localhost
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        if (!isSecure) {
            return false;
        }
        
        // Pr√ºfe verf√ºgbare Ger√§te
        const devices = await navigator.mediaDevices.enumerateDevices();
        const hasCamera = devices.some(device => device.kind === 'videoinput');
        
        return hasCamera;
    } catch (error) {
        console.log('Kamera-Verf√ºgbarkeitspr√ºfung fehlgeschlagen:', error);
        return false;
    }
}

function backToNameStep() {
    // Stop camera if running
    stopCamera();
    
    // Switch back to name step
    document.getElementById('step-2').classList.remove('show');
    document.getElementById('step-1').style.display = 'block';
    
    // Update step indicator
    document.getElementById('step-dot-2').classList.remove('active');
    document.getElementById('step-dot-1').classList.add('active');
    
    // Clear status
    document.getElementById('registration-status').style.display = 'none';
}

function resetCameraUI() {
    stopCamera();
    
    document.getElementById('btn-start-camera').style.display = 'inline-block';
    document.getElementById('btn-take-photo').style.display = 'none';
    document.getElementById('btn-retake-photo').style.display = 'none';
    document.getElementById('btn-save-and-register').style.display = 'none';
    
    document.getElementById('camera-video').style.display = 'block';
    document.getElementById('camera-captured').style.display = 'none';
    
    document.getElementById('camera-status').textContent = 'Klicke auf "Kamera starten" um ein Selfie aufzunehmen.';
    
    capturedImageData = null;
}

async function startCamera() {
    try {
        document.getElementById('camera-status').textContent = 'Kamera wird gestartet...';
        
        // Pr√ºfe ob getUserMedia verf√ºgbar ist
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Kamera-API nicht verf√ºgbar. HTTPS oder neuerer Browser erforderlich.');
        }
        
        // Pr√ºfe ob HTTPS oder localhost (aber biete Alternativen f√ºr HTTP)
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        if (!isSecure) {
            // Versuche trotzdem - manche Browser/Desktops erlauben es
            console.log('HTTP erkannt - versuche trotzdem Kamera-Zugriff...');
        }
        
        // Benutzerfreundliche Berechtigungsabfrage
        document.getElementById('camera-status').innerHTML = `
            <div>üì± Bitte erlaube den Kamera-Zugriff...</div>
            <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;">
                Ein Berechtigungs-Dialog sollte erscheinen. Klicke auf "Erlauben" oder "Allow".
            </div>
        `;
        
        // Versuche zuerst eine explizite Berechtigungsabfrage (f√ºr moderne Browser)
        try {
            if (navigator.permissions) {
                const permission = await navigator.permissions.query({name: 'camera'});
                console.log('Kamera-Berechtigung Status:', permission.state);
                
                if (permission.state === 'denied') {
                    throw new Error('Kamera-Berechtigung wurde dauerhaft verweigert.');
                }
            }
        } catch (permError) {
            console.log('Berechtigungsabfrage nicht verf√ºgbar oder verweigert:', permError);
        }
        
        // Versuche zuerst mit optimalen Mobile-Einstellungen
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user', // Front-Kamera bevorzugen
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 640, max: 1280 }
                } 
            });
        } catch (basicError) {
            console.log('Optimale Kamera-Einstellungen fehlgeschlagen, versuche Fallback:', basicError);
            
            // Fallback 1: Nur Front-Kamera ohne Gr√∂√üenbeschr√§nkung
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }
                });
            } catch (frontError) {
                console.log('Front-Kamera fehlgeschlagen, versuche beliebige Kamera:', frontError);
                
                // Fallback 2: Beliebige Kamera
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true 
                });
            }
        }
        
        const video = document.getElementById('camera-video');
        video.srcObject = cameraStream;
        
        // Warte bis Video geladen ist
        video.onloadedmetadata = function() {
            video.play();
            document.getElementById('btn-start-camera').style.display = 'none';
            document.getElementById('btn-take-photo').style.display = 'inline-block';
            document.getElementById('camera-status').textContent = 'Kamera aktiv - Position dich gut und klicke auf "Foto aufnehmen".';
        };
        
    } catch (error) {
        console.error('Kamera-Fehler:', error);
        
        let errorMessage = 'Kamera konnte nicht gestartet werden.';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isMobile || isIOS) {
                errorMessage = `
                    ‚ùå Kamera-Berechtigung verweigert
                    <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                        üì± <strong>F√ºr Smartphones:</strong>
                        <br>‚Ä¢ Tippe auf das Schloss-Symbol in der Adressleiste
                        <br>‚Ä¢ W√§hle "Kamera" ‚Üí "Erlauben"
                        <br>‚Ä¢ Lade die Seite neu (F5)
                        ${isIOS ? '<br>‚Ä¢ F√ºr Safari: Einstellungen ‚Üí Safari ‚Üí Kamera' : ''}
                    </div>
                `;
            } else {
                errorMessage = '‚ùå Kamera-Berechtigung verweigert. Klicke auf das Kamera-Symbol in der Adressleiste und erlaube den Zugriff.';
            }
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = '‚ùå Keine Kamera gefunden. Stelle sicher, dass eine Kamera angeschlossen ist.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = '‚ùå Kamera wird bereits von einer anderen App verwendet. Schlie√üe andere Kamera-Apps.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
            errorMessage = '‚ùå Kamera unterst√ºtzt die gew√ºnschten Einstellungen nicht.';
        } else if (error.message.includes('HTTPS')) {
            errorMessage = '‚ùå Kamera ben√∂tigt HTTPS. Versuche "Foto hochladen" als Alternative.';
            
            // Zeige Upload-Button bei HTTPS-Fehler
            const uploadButton = document.getElementById('btn-upload-file');
            if (uploadButton) {
                uploadButton.style.display = 'inline-block';
                uploadButton.style.background = 'linear-gradient(45deg, #2196F3, #1976D2)';
            }
        } else if (error.message.includes('nicht verf√ºgbar')) {
            errorMessage = '‚ùå Kamera-API nicht verf√ºgbar. Bitte verwende einen neueren Browser.';
        } else if (error.message.includes('dauerhaft verweigert')) {
            errorMessage = `
                ‚ùå Kamera-Berechtigung dauerhaft verweigert
                <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                    üîß <strong>So behebst du das:</strong>
                    <br>‚Ä¢ Chrome: Adressleiste ‚Üí Schloss-Symbol ‚Üí Kamera ‚Üí Erlauben
                    <br>‚Ä¢ Firefox: Adressleile ‚Üí Schild-Symbol ‚Üí Berechtigungen ‚Üí Kamera
                    <br>‚Ä¢ Safari: Einstellungen ‚Üí Websites ‚Üí Kamera
                    <br>‚Ä¢ Dann Seite neu laden
                </div>
            `;
        } else {
            errorMessage = `‚ùå Kamera-Fehler: ${error.message}`;
        }
        
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #ff6b6b; margin-bottom: 1rem;">${errorMessage}</div>
            <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 1rem;">
                üí° <strong>Weitere Tipps:</strong>
                <br>‚Ä¢ Stelle sicher, dass die Seite √ºber HTTPS geladen wird
                <br>‚Ä¢ Verwende einen aktuellen Browser (Chrome, Firefox, Safari)
                <br>‚Ä¢ Schlie√üe andere Apps die die Kamera verwenden k√∂nnten
                <br>‚Ä¢ Bei dauerhaften Problemen: "Ohne Foto fortfahren" w√§hlen
            </div>
        `;
        
        // Zeige "Ohne Foto" Option prominenter an
        const skipButton = document.getElementById('btn-skip-photo');
        if (skipButton) {
            skipButton.style.background = 'linear-gradient(45deg, #4CAF50, #45A049)';
            skipButton.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto fortfahren (empfohlen)';
        }
        
        // Zeige Berechtigungen-Pr√ºf-Button bei bestimmten Fehlern
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError' || error.message.includes('dauerhaft verweigert')) {
            const checkButton = document.getElementById('btn-check-permissions');
            if (checkButton) {
                checkButton.style.display = 'inline-block';
            }
        }
    }
}

async function checkAndRequestPermissions() {
    try {
        document.getElementById('camera-status').innerHTML = `
            <div>üîç Pr√ºfe Kamera-Berechtigungen...</div>
        `;
        
        // Pr√ºfe aktuellen Berechtigungsstatus
        if (navigator.permissions) {
            try {
                const permission = await navigator.permissions.query({name: 'camera'});
                console.log('Kamera-Berechtigung:', permission.state);
                
                if (permission.state === 'granted') {
                    document.getElementById('camera-status').innerHTML = `
                        <div style="color: #4CAF50;">‚úÖ Kamera-Berechtigung erteilt!</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche jetzt "Kamera starten"</div>
                    `;
                    return;
                } else if (permission.state === 'denied') {
                    document.getElementById('camera-status').innerHTML = `
                        <div style="color: #ff6b6b;">‚ùå Kamera-Berechtigung verweigert</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">
                            Bitte erlaube den Kamera-Zugriff in deinen Browser-Einstellungen:
                            <br>‚Ä¢ Klicke auf das Schloss-Symbol in der Adressleiste
                            <br>‚Ä¢ W√§hle "Kamera" ‚Üí "Erlauben"
                            <br>‚Ä¢ Lade die Seite neu
                        </div>
                    `;
                    return;
                } else {
                    document.getElementById('camera-status').innerHTML = `
                        <div style="color: #ffa726;">‚ö†Ô∏è Kamera-Berechtigung noch nicht erteilt</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche "Kamera starten" um die Berechtigung anzufordern</div>
                    `;
                    return;
                }
            } catch (permError) {
                console.log('Permissions API nicht verf√ºgbar:', permError);
            }
        }
        
        // Fallback: Versuche direkte Ger√§te-Auflistung
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(device => device.kind === 'videoinput');
            
            if (cameras.length === 0) {
                document.getElementById('camera-status').innerHTML = `
                    <div style="color: #ff6b6b;">‚ùå Keine Kamera gefunden</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">Stelle sicher, dass eine Kamera angeschlossen und aktiviert ist</div>
                `;
            } else {
                document.getElementById('camera-status').innerHTML = `
                    <div style="color: #4CAF50;">‚úÖ ${cameras.length} Kamera(s) gefunden</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche jetzt "Kamera starten"</div>
                `;
            }
        } catch (deviceError) {
            document.getElementById('camera-status').innerHTML = `
                <div style="color: #ffa726;">‚ö†Ô∏è Kann Ger√§te nicht auflisten</div>
                <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche trotzdem "Kamera starten"</div>
            `;
        }
        
    } catch (error) {
        console.error('Berechtigungspr√ºfung fehlgeschlagen:', error);
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #ff6b6b;">‚ùå Berechtigungspr√ºfung fehlgeschlagen</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche "Kamera starten" oder "Ohne Foto fortfahren"</div>
        `;
    }
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
}

function takePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const capturedImg = document.getElementById('camera-captured');
    
    canvas.width = 150;
    canvas.height = 150;
    
    const ctx = canvas.getContext('2d');
    
    // Kreisrunden Schnitt
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(75, 75, 75, 0, 2 * Math.PI);
    ctx.clip();
    
    // Video gespiegelt zeichnen
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 0.85);
    
    // Vorschau anzeigen
    capturedImg.src = capturedImageData;
    capturedImg.style.display = 'block';
    video.style.display = 'none';
    
    // Buttons anpassen
    document.getElementById('btn-take-photo').style.display = 'none';
    document.getElementById('btn-retake-photo').style.display = 'inline-block';
    document.getElementById('btn-save-and-register').style.display = 'inline-block';
    
    document.getElementById('camera-status').textContent = 'Foto aufgenommen! Gef√§llt es dir?';
    
    stopCamera();
}

function retakePhoto() {
    document.getElementById('camera-video').style.display = 'block';
    document.getElementById('camera-captured').style.display = 'none';
    
    document.getElementById('btn-retake-photo').style.display = 'none';
    document.getElementById('btn-save-and-register').style.display = 'none';
    document.getElementById('btn-start-camera').style.display = 'inline-block';
    
    capturedImageData = null;
    document.getElementById('camera-status').textContent = 'Klicke auf "Kamera starten" um es nochmal zu versuchen.';
}

async function savePhotoAndRegister() {
    const playerName = document.getElementById('player-name').value.trim();
    
    if (!playerName) {
        showRegistrationStatus('Spielername fehlt!', 'error');
        return;
    }
    
    // Button deaktivieren w√§hrend der Anmeldung
    const saveBtn = document.getElementById('btn-save-and-register');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird gespeichert...';
    }
    
    try {
        // Erst Spieler registrieren
        const playerRegistered = await registerPlayer(playerName);
        
        // Dann Foto hochladen falls erfolgreich und Foto vorhanden
        if (playerRegistered && capturedImageData) {
            await uploadProfileImage(playerName);
        }
    } finally {
        // Button wieder aktivieren
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Speichern & Anmelden';
        }
    }
}

async function skipPhotoAndRegister() {
    const playerName = document.getElementById('player-name').value.trim();
    
    if (!playerName) {
        showRegistrationStatus('Spielername fehlt!', 'error');
        return;
    }
    
    // Button deaktivieren w√§hrend der Anmeldung
    const skipBtn = document.getElementById('btn-skip-photo');
    if (skipBtn) {
        skipBtn.disabled = true;
        skipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Wird angemeldet...';
    }
    
    try {
        await registerPlayer(playerName);
    } finally {
        // Button wieder aktivieren
        if (skipBtn) {
            skipBtn.disabled = false;
            skipBtn.innerHTML = '<i class="fas fa-forward"></i> Ohne Foto anmelden';
        }
    }
}

async function registerPlayer(playerName) {
    try {
        document.getElementById('camera-status').textContent = 'Spieler wird angemeldet...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        console.log('Sending registration request:', {
            player_name: playerName,
            csrf_token: csrfToken ? '***' : 'NOT_FOUND'
        });
        
        const response = await fetch('/api/register-player', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ player_name: playerName })
        });
        
        if (!response.ok) {
            // Bei 400 Bad Request, versuche JSON Response zu lesen f√ºr Fehlerdetails
            if (response.status === 400) {
                try {
                    const text = await response.text();
                    console.error('400 Bad Request response:', text);
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    } catch (parseError) {
                        console.error('Could not parse error response as JSON:', parseError);
                        throw new Error(`HTTP error! status: ${response.status} - ${text}`);
                    }
                } catch (readError) {
                    console.error('Could not read error response:', readError);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Expected JSON, got:', text);
            throw new Error('Server returned non-JSON response');
        }
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('camera-status').textContent = '‚úÖ Spieler erfolgreich angemeldet!';
            showRegistrationStatus('Erfolgreich angemeldet! üéâ', 'success');
            setTimeout(() => {
                closeRegistrationPopup();
            }, 2000);
            return true;
        } else {
            showRegistrationStatus(data.error || 'Fehler bei der Anmeldung', 'error');
            document.getElementById('camera-status').innerHTML = `<div style="color: #ff6b6b;">‚ùå ${data.error || 'Fehler bei der Anmeldung'}</div>`;
            return false;
        }
        
    } catch (error) {
        console.error('Registration error:', error);
        let errorMessage = 'Ein Fehler ist aufgetreten. Versuche es nochmal!';
        if (error.message.includes('Server returned non-JSON response')) {
            errorMessage = 'Server-Fehler: Ung√ºltige Antwort erhalten';
        } else if (error.message.includes('HTTP error!')) {
            errorMessage = 'Netzwerk-Fehler: Verbindung zum Server fehlgeschlagen';
        }
        showRegistrationStatus(errorMessage, 'error');
        document.getElementById('camera-status').innerHTML = `<div style="color: #ff6b6b;">‚ùå ${errorMessage}</div>`;
        return false;
    }
}

async function uploadProfileImage(playerName) {
    try {
        document.getElementById('camera-status').textContent = 'Profilbild wird gespeichert...';
        
        const response = await fetch('/api/upload-profile-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player_name: playerName,
                image_data: capturedImageData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('camera-status').textContent = '‚úÖ Profilbild gespeichert!';
            showRegistrationStatus('Erfolgreich angemeldet mit Profilbild! üéâüì∏', 'success');
        } else {
            showRegistrationStatus('Angemeldet, aber Profilbild-Fehler: ' + result.error, 'error');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        showRegistrationStatus('Angemeldet, aber Profilbild konnte nicht gespeichert werden.', 'error');
    } finally {
        setTimeout(() => {
            closeRegistrationPopup();
        }, 3000);
    }
}

// Erweitere closeRegistrationPopup Funktion
const originalCloseRegistrationPopup = window.closeRegistrationPopup;
window.closeRegistrationPopup = function() {
    stopCamera();
    
    // Reset to step 1
    document.getElementById('step-2').classList.remove('show');
    document.getElementById('step-1').style.display = 'block';
    document.getElementById('step-dot-2').classList.remove('active');
    document.getElementById('step-dot-1').classList.add('active');
    
    // Reset form
    document.getElementById('player-name').value = '';
    document.getElementById('registration-status').style.display = 'none';
    
    resetCameraUI();
    
    if (originalCloseRegistrationPopup) {
        originalCloseRegistrationPopup();
    } else {
        document.getElementById('registration-popup').classList.remove('show');
    }
};

// Camera cleanup bei Seitenverlassen
window.addEventListener('beforeunload', function() {
    stopCamera();
});

// DATEI-UPLOAD FUNKTIONEN (HTTP-Alternative)

function triggerFileUpload() {
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.click();
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    
    // Pr√ºfe Dateityp
    if (!file.type.startsWith('image/')) {
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #ff6b6b;">‚ùå Bitte w√§hle eine Bilddatei (JPG, PNG, etc.)</div>
        `;
        return;
    }
    
    // Pr√ºfe Dateigr√∂√üe (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #ff6b6b;">‚ùå Datei zu gro√ü (max. 10MB)</div>
        `;
        return;
    }
    
    document.getElementById('camera-status').textContent = 'Bild wird verarbeitet...';
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Resize und process das Bild
            processUploadedImage(img);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function processUploadedImage(img) {
    try {
        const canvas = document.getElementById('camera-canvas');
        const capturedImg = document.getElementById('camera-captured');
        const video = document.getElementById('camera-video');
        
        // Canvas setup f√ºr 150x150 kreisrund
        canvas.width = 150;
        canvas.height = 150;
        
        const ctx = canvas.getContext('2d');
        
        // Kreisrunden Schnitt vorbereiten
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(75, 75, 75, 0, 2 * Math.PI);
        ctx.clip();
        
        // Berechne optimale Crop-Gr√∂√üe (quadratisch, zentriert)
        const size = Math.min(img.width, img.height);
        const startX = (img.width - size) / 2;
        const startY = (img.height - size) / 2;
        
        // Zeichne Bild zentriert und quadratisch
        ctx.drawImage(img, startX, startY, size, size, 0, 0, canvas.width, canvas.height);
        
        // Speichere als Base64
        capturedImageData = canvas.toDataURL('image/jpeg', 0.85);
        
        // Zeige Vorschau
        capturedImg.src = capturedImageData;
        capturedImg.style.display = 'block';
        video.style.display = 'none';
        
        // Update Buttons
        document.getElementById('btn-start-camera').style.display = 'none';
        document.getElementById('btn-upload-file').style.display = 'none';
        document.getElementById('btn-take-photo').style.display = 'none';
        document.getElementById('btn-retake-photo').style.display = 'inline-block';
        document.getElementById('btn-save-and-register').style.display = 'inline-block';
        
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #4CAF50;">‚úÖ Bild erfolgreich hochgeladen!</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Gef√§llt es dir? Speichern oder neues Bild w√§hlen.</div>
        `;
        
    } catch (error) {
        console.error('Bild-Verarbeitung fehlgeschlagen:', error);
        document.getElementById('camera-status').innerHTML = `
            <div style="color: #ff6b6b;">‚ùå Bild konnte nicht verarbeitet werden</div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Versuche ein anderes Bild oder "Ohne Foto fortfahren"</div>
        `;
    }
}

function retakePhoto() {
    // Reset f√ºr sowohl Kamera als auch Upload
    document.getElementById('camera-video').style.display = 'block';
    document.getElementById('camera-captured').style.display = 'none';
    
    document.getElementById('btn-retake-photo').style.display = 'none';
    document.getElementById('btn-save-and-register').style.display = 'none';
    document.getElementById('btn-start-camera').style.display = 'inline-block';
    
    // Zeige Upload-Button wenn HTTP oder Kamera-Probleme
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!isSecure) {
        document.getElementById('btn-upload-file').style.display = 'inline-block';
    }
    
    capturedImageData = null;
    document.getElementById('camera-status').textContent = 'Klicke auf "Kamera starten" oder w√§hle "Foto hochladen".';
    
    // Reset file input
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.value = '';
    }
}

console.log('‚úÖ Camera-System f√ºr Registration Modal geladen');
console.log('‚úÖ File-Upload Alternative f√ºr HTTP aktiviert');

// Removed smooth transitions to prevent browser back button issues

</script>
{% endblock %}